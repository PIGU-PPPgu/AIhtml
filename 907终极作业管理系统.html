<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ğŸ“š ç»ˆæä½œä¸šç®¡ç†ç³»ç»Ÿ</title>
    <style>
        :root {
            --pink: #ff9eb5;
            --blue: #87d7eb;
            --shadow: 0 4px 8px rgba(255,158,181,0.2);
        }
        body {
            font-family: 'å¾®è½¯é›…é»‘', sans-serif;
            background: #fff5f7;
            padding: 20px;
            margin: 0;
        }
        .container {
            display: grid;
            grid-template-columns: 75% 25%;
            gap: 25px;
        }
        .header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 25px;
        }
        .date-control {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .date-btn {
            background: var(--pink);
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 15px;
            cursor: pointer;
            transition: 0.2s;
        }
        .date-btn:hover {
            opacity: 0.9;
            transform: scale(1.05);
        }
        #currentDate {
            color: #666;
            font-size: 16px;
            min-width: 180px;
            text-align: center;
        }
        .student-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 15px;
        }
        .student-card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            min-height: 110px;
            box-shadow: var(--shadow);
            transition: 0.3s;
            border: 2px solid var(--pink);
            cursor: pointer;
        }
        .student-card:hover {
            transform: translateY(-3px);
        }
        .subject-tag {
            display: inline-block;
            padding: 5px 12px;
            margin: 3px;
            border-radius: 15px;
            background: var(--blue);
            color: white;
            font-size: 12px;
        }
        #subjectPopup {
            background: white;
            border: 3px solid var(--pink);
            width: 500px;
            padding: 25px;
            border-radius: 20px;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
            display: none;
            z-index: 100;
        }
        .subject-btn {
            font-size: 14px;
            padding: 10px 20px;
            border-radius: 20px;
            margin: 5px;
            border: 2px solid var(--pink);
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .subject-btn.active {
            background: var(--pink);
            color: white !important;
            transform: scale(1.08);
        }
        .all-clear {
            color: #aaa;
            font-size: 12px;
            margin-top: 8px;
        }
        .rank-section {
            margin-bottom: 25px;
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div>
            <div class="header">
                <h1 style="color:var(--pink); margin:0">ğŸ“š ä½œä¸šç™»è®°ç³»ç»Ÿ</h1>
                <div class="date-control">
                    <button class="date-btn" onclick="changeDate(-1)">â† å‰ä¸€å¤©</button>
                    <div id="currentDate"></div>
                    <button class="date-btn" onclick="changeDate(1)">åä¸€å¤© â†’</button>
                </div>
            </div>
            <div class="student-grid" id="studentList"></div>
        </div>

        <div style="position:sticky; top:20px">
            <h2 style="color:var(--pink); margin-top:0">â° å­¦ç§‘æœªäº¤æ¦œ</h2>
            <div id="rankContainer"></div>
        </div>

        <div id="subjectPopup">
            <h3 id="currentStudent" style="color:var(--pink); margin:0 0 20px 0"></h3>
            <div id="subjectList"></div>
            <div style="text-align:center; margin-top:25px">
                <button onclick="confirmSelection()" 
                        style="background:var(--pink); color:white; padding:10px 35px; border-radius:25px; border:none; cursor:pointer">
                    ğŸ’¾ ä¿å­˜ç™»è®°
                </button>
            </div>
        </div>
    </div>

<script>
// ========== æ–°ç‰ˆæ•°æ®å­˜å‚¨ç»“æ„ ==========
let storage = JSON.parse(localStorage.getItem('hwData')) || { 
    stats: {},      // ç´¯è®¡ç»Ÿè®¡æ•°æ®
    daily: {},      // æŒ‰æ—¥æœŸå­˜å‚¨æ¯æ—¥è®°å½•
    latestDate: ""  // æœ€æ–°æ“ä½œæ—¥æœŸ
};

// ========== æ—¥æœŸç®¡ç†ç³»ç»Ÿ ==========
let currentViewDate = new Date(); // å½“å‰æŸ¥çœ‹çš„æ—¥æœŸ

// åˆå§‹åŒ–æ—¥æœŸæ˜¾ç¤º
function updateDateDisplay() {
    const dateStr = formatDate(currentViewDate);
    document.getElementById('currentDate').textContent = dateStr;
    checkDateData(dateStr); // ç¡®ä¿å½“å¤©æ•°æ®å­˜åœ¨
    renderStudents();
    renderRanking();
}

// æ—¥æœŸæ ¼å¼åŒ–å·¥å…·
function formatDate(date) {
    return date.toISOString().split('T')[0]; // YYYY-MM-DDæ ¼å¼
}

// æ—¥æœŸåˆ‡æ¢åŠŸèƒ½
function changeDate(deltaDays) {
    currentViewDate.setDate(currentViewDate.getDate() + deltaDays);
    updateDateDisplay();
}

// éªŒè¯å¹¶åˆå§‹åŒ–æ¯æ—¥æ•°æ®
function checkDateData(dateStr) {
    if (!storage.daily[dateStr]) {
        storage.daily[dateStr] = {};
        STUDENTS.forEach(name => {
            storage.daily[dateStr][name] = [];
        });
    }
}

// ========== æ ¸å¿ƒä¸šåŠ¡åŠŸèƒ½ ==========
// åˆå§‹åŒ–å­¦ç”Ÿç»Ÿè®¡
const STUDENTS = [
   "æ—å˜‰çª","å´”åª›ç†™","è”¡æ·³ç¿","æ—å³»å®‡","éƒ‘å¦‚æ–‡","æ¨æ³½ç¿°","ææ²é«","ç½—å®¶å¨","é™ˆå’æ€¡","å¼ æ¢“æ¥ ","æ¯›åº·","ç‹å®‡æµ©","ä¸å‡¯çš“","å¼ ä½³ç¥º","åˆ˜è°­æ¥ æ¬£","ç½—å®¶ä¹","èµµä½³è±","éŸ¦è¯­æ¢¦","é½ç´«ç‰","æœ±å¨œ","èµ–é™éœ","æ¢éš½ç†™","å´ä½³èˆª","é™ˆè¯¸è€€","æ¨éœ–","é™ˆç³åš","æ±¤é’§çš“","é»„è‹¥æ¶µ","é’Ÿé›¨é¦¨","è¿æ™“ç¼","æ±Ÿæ–‡é™","åˆ˜æ·‘ç²","å¼ æµ©å®‡","é™ˆç¡•","æ´ªé”¦é¾™","å¢å­ç‚€","å‘¨å®¶è°¦","è¿åŒé”‹","å†·ç³ç†¹","æ¢ä¸œå®š","åˆ˜é½","è¢æ™¨","é™ˆç§‹é‰´","æ¨åšæ–‡","é™ˆå›½å¿","å¼ ç±³"
];
const SUBJECTS = ["è¯­æ–‡","æ•°å­¦","è‹±è¯­","ç‰©ç†","åŒ–å­¦","å†å²","é“æ³•"];

// åˆå§‹åŒ–æ•°æ®å­˜å‚¨
(function init(){
    STUDENTS.forEach(name => {
        if (!storage.stats[name]) {
            storage.stats[name] = SUBJECTS.reduce((acc, sub) => {
                acc[sub] = 0;
                return acc;
            }, {});
        }
    });
    // æ•°æ®è¿ç§»é€»è¾‘ï¼ˆæ—§ç‰ˆå…¼å®¹ï¼‰
    if (storage.today) {
        const today = formatDate(new Date());
        storage.daily[today] = storage.today;
        delete storage.today;
    }
    currentViewDate = new Date(storage.latestDate || new Date());
    updateDateDisplay();
})();

// æ¸²æŸ“å­¦ç”Ÿå¡ç‰‡
function renderStudents() {
    const dateStr = formatDate(currentViewDate);
    document.getElementById('studentList').innerHTML = STUDENTS.map(name => {
        const missed = storage.daily[dateStr][name];
        return `
        <div class="student-card" onclick="openSubjectPopup('${name}')">
            <div style="font-weight:bold; color:var(--pink); margin-bottom:6px">${name}</div>
            ${missed.length ? 
                missed.map(sub => `<div class="subject-tag">${sub}</div>`).join('') : 
                '<div class="all-clear">ğŸ‰ ä½œä¸šå…¨é½</div>'
            }
        </div>`;
    }).join('');
}

// æ‰“å¼€ç™»è®°çª—å£
let currentStudent = null;
function openSubjectPopup(name) {
    currentStudent = name;
    const dateStr = formatDate(currentViewDate);
    const popup = document.getElementById('subjectPopup');
    popup.style.display = 'block';
    document.getElementById('currentStudent').textContent = `æ­£åœ¨ç™»è®°ï¼š${name}ï¼ˆ${dateStr}ï¼‰`;

    const currentSelected = storage.daily[dateStr][name];
    document.getElementById('subjectList').innerHTML = SUBJECTS.map(sub => `
        <button class="subject-btn ${currentSelected.includes(sub) ? 'active' : ''}" 
                onclick="this.classList.toggle('active')">
            ${sub}
        </button>
    `).join('');
}

// ä¿å­˜ç™»è®°æ•°æ®
function confirmSelection() {
    const dateStr = formatDate(currentViewDate);
    const selected = Array.from(document.querySelectorAll('#subjectList .active'))
                         .map(btn => btn.textContent.trim());
    const original = storage.daily[dateStr][currentStudent];

    // ç»Ÿè®¡ä¿®æ­£é€»è¾‘
    original.filter(sub => !selected.includes(sub)).forEach(sub => {
        storage.stats[currentStudent][sub] = Math.max(0, storage.stats[currentStudent][sub] - 1);
    });
    selected.filter(sub => !original.includes(sub)).forEach(sub => {
        storage.stats[currentStudent][sub] += 1;
    });

    // æ›´æ–°å­˜å‚¨
    storage.daily[dateStr][currentStudent] = selected;
    storage.latestDate = dateStr;
    localStorage.setItem('hwData', JSON.stringify(storage));
    
    refreshAll();
}

// ========== æ’è¡Œæ¦œç³»ç»Ÿ ==========
function renderRanking() {
    document.getElementById('rankContainer').innerHTML = SUBJECTS.map(sub => {
        const list = Object.entries(storage.stats)
            .filter(([_, data]) => data[sub] > 0)
            .sort((a, b) => b[1][sub] - a[1][sub])
            .slice(0, 5)
            .map(([name, data], index) => `
                <div style="padding:8px 0; border-bottom:1px dashed #eee">
                    <span style="color:var(--pink)">${index + 1}.</span> ${name}
                    <span style="float:right; color:#666">${data[sub]}æ¬¡</span>
                </div>
            `).join('');
        
        return `
        <div class="rank-section">
            <h3 style="color:var(--blue); margin:10px 0 5px">${sub}æœªäº¤æ¦œï¼ˆç´¯è®¡ï¼‰</h3>
            ${list || '<div style="color:#aaa; padding:8px 0">âœ… å…¨å‘˜æŒ‰æ—¶å®Œæˆ</div>'}
        </div>`;
    }).join('');
}

// ========== é€šç”¨åŠŸèƒ½ ==========
function refreshAll() {
    document.getElementById('subjectPopup').style.display = 'none';
    renderStudents();
    renderRanking();
}

document.addEventListener('click', (e) => {
    if (e.target.id === 'subjectPopup') {
        document.getElementById('subjectPopup').style.display = 'none';
    }
});
</script>
</body>
</html>
