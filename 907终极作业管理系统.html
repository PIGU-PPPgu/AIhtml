<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>📚 终极作业管理系统</title>
    <style>
        :root {
            --pink: #ff9eb5;
            --blue: #87d7eb;
            --shadow: 0 4px 8px rgba(255,158,181,0.2);
        }
        body {
            font-family: '微软雅黑', sans-serif;
            background: #fff5f7;
            padding: 20px;
            margin: 0;
        }
        .container {
            display: grid;
            grid-template-columns: 75% 25%;
            gap: 25px;
        }
        .header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 25px;
        }
        .date-control {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .date-btn {
            background: var(--pink);
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 15px;
            cursor: pointer;
            transition: 0.2s;
        }
        .date-btn:hover {
            opacity: 0.9;
            transform: scale(1.05);
        }
        #currentDate {
            color: #666;
            font-size: 16px;
            min-width: 180px;
            text-align: center;
        }
        .student-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 15px;
        }
        .student-card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            min-height: 110px;
            box-shadow: var(--shadow);
            transition: 0.3s;
            border: 2px solid var(--pink);
            cursor: pointer;
        }
        .student-card:hover {
            transform: translateY(-3px);
        }
        .subject-tag {
            display: inline-block;
            padding: 5px 12px;
            margin: 3px;
            border-radius: 15px;
            background: var(--blue);
            color: white;
            font-size: 12px;
        }
        #subjectPopup {
            background: white;
            border: 3px solid var(--pink);
            width: 500px;
            padding: 25px;
            border-radius: 20px;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
            display: none;
            z-index: 100;
        }
        .subject-btn {
            font-size: 14px;
            padding: 10px 20px;
            border-radius: 20px;
            margin: 5px;
            border: 2px solid var(--pink);
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .subject-btn.active {
            background: var(--pink);
            color: white !important;
            transform: scale(1.08);
        }
        .all-clear {
            color: #aaa;
            font-size: 12px;
            margin-top: 8px;
        }
        .rank-section {
            margin-bottom: 25px;
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div>
            <div class="header">
                <h1 style="color:var(--pink); margin:0">📚 作业登记系统</h1>
                <div class="date-control">
                    <button class="date-btn" onclick="changeDate(-1)">← 前一天</button>
                    <div id="currentDate"></div>
                    <button class="date-btn" onclick="changeDate(1)">后一天 →</button>
                </div>
            </div>
            <div class="student-grid" id="studentList"></div>
        </div>

        <div style="position:sticky; top:20px">
            <h2 style="color:var(--pink); margin-top:0">⏰ 学科未交榜</h2>
            <div id="rankContainer"></div>
        </div>

        <div id="subjectPopup">
            <h3 id="currentStudent" style="color:var(--pink); margin:0 0 20px 0"></h3>
            <div id="subjectList"></div>
            <div style="text-align:center; margin-top:25px">
                <button onclick="confirmSelection()" 
                        style="background:var(--pink); color:white; padding:10px 35px; border-radius:25px; border:none; cursor:pointer">
                    💾 保存登记
                </button>
            </div>
        </div>
    </div>

<script>
// ========== 新版数据存储结构 ==========
let storage = JSON.parse(localStorage.getItem('hwData')) || { 
    stats: {},      // 累计统计数据
    daily: {},      // 按日期存储每日记录
    latestDate: ""  // 最新操作日期
};

// ========== 日期管理系统 ==========
let currentViewDate = new Date(); // 当前查看的日期

// 初始化日期显示
function updateDateDisplay() {
    const dateStr = formatDate(currentViewDate);
    document.getElementById('currentDate').textContent = dateStr;
    checkDateData(dateStr); // 确保当天数据存在
    renderStudents();
    renderRanking();
}

// 日期格式化工具
function formatDate(date) {
    return date.toISOString().split('T')[0]; // YYYY-MM-DD格式
}

// 日期切换功能
function changeDate(deltaDays) {
    currentViewDate.setDate(currentViewDate.getDate() + deltaDays);
    updateDateDisplay();
}

// 验证并初始化每日数据
function checkDateData(dateStr) {
    if (!storage.daily[dateStr]) {
        storage.daily[dateStr] = {};
        STUDENTS.forEach(name => {
            storage.daily[dateStr][name] = [];
        });
    }
}

// ========== 核心业务功能 ==========
// 初始化学生统计
const STUDENTS = [
   "林嘉琪","崔媛熙","蔡淳睿","林峻宇","郑如文","杨泽翰","李杲髁","罗家威","陈咏怡","张梓楠","毛康","王宇浩","丁凯皓","张佳祺","刘谭楠欣","罗家乐","赵佳萱","韦语梦","齐紫玉","朱娜","赖静霞","梁隽熙","吴佳航","陈诸耀","杨霖","陈琳坚","汤钧皓","黄若涵","钟雨馨","连晓琼","江文静","刘淑玲","张浩宇","陈硕","洪锦龙","卢子炀","周家谦","连同锋","冷琳熹","梁东定","刘齐","袁晨","陈秋鉴","杨博文","陈国卿","张米"
];
const SUBJECTS = ["语文","数学","英语","物理","化学","历史","道法"];

// 初始化数据存储
(function init(){
    STUDENTS.forEach(name => {
        if (!storage.stats[name]) {
            storage.stats[name] = SUBJECTS.reduce((acc, sub) => {
                acc[sub] = 0;
                return acc;
            }, {});
        }
    });
    // 数据迁移逻辑（旧版兼容）
    if (storage.today) {
        const today = formatDate(new Date());
        storage.daily[today] = storage.today;
        delete storage.today;
    }
    currentViewDate = new Date(storage.latestDate || new Date());
    updateDateDisplay();
})();

// 渲染学生卡片
function renderStudents() {
    const dateStr = formatDate(currentViewDate);
    document.getElementById('studentList').innerHTML = STUDENTS.map(name => {
        const missed = storage.daily[dateStr][name];
        return `
        <div class="student-card" onclick="openSubjectPopup('${name}')">
            <div style="font-weight:bold; color:var(--pink); margin-bottom:6px">${name}</div>
            ${missed.length ? 
                missed.map(sub => `<div class="subject-tag">${sub}</div>`).join('') : 
                '<div class="all-clear">🎉 作业全齐</div>'
            }
        </div>`;
    }).join('');
}

// 打开登记窗口
let currentStudent = null;
function openSubjectPopup(name) {
    currentStudent = name;
    const dateStr = formatDate(currentViewDate);
    const popup = document.getElementById('subjectPopup');
    popup.style.display = 'block';
    document.getElementById('currentStudent').textContent = `正在登记：${name}（${dateStr}）`;

    const currentSelected = storage.daily[dateStr][name];
    document.getElementById('subjectList').innerHTML = SUBJECTS.map(sub => `
        <button class="subject-btn ${currentSelected.includes(sub) ? 'active' : ''}" 
                onclick="this.classList.toggle('active')">
            ${sub}
        </button>
    `).join('');
}

// 保存登记数据
function confirmSelection() {
    const dateStr = formatDate(currentViewDate);
    const selected = Array.from(document.querySelectorAll('#subjectList .active'))
                         .map(btn => btn.textContent.trim());
    const original = storage.daily[dateStr][currentStudent];

    // 统计修正逻辑
    original.filter(sub => !selected.includes(sub)).forEach(sub => {
        storage.stats[currentStudent][sub] = Math.max(0, storage.stats[currentStudent][sub] - 1);
    });
    selected.filter(sub => !original.includes(sub)).forEach(sub => {
        storage.stats[currentStudent][sub] += 1;
    });

    // 更新存储
    storage.daily[dateStr][currentStudent] = selected;
    storage.latestDate = dateStr;
    localStorage.setItem('hwData', JSON.stringify(storage));
    
    refreshAll();
}

// ========== 排行榜系统 ==========
function renderRanking() {
    document.getElementById('rankContainer').innerHTML = SUBJECTS.map(sub => {
        const list = Object.entries(storage.stats)
            .filter(([_, data]) => data[sub] > 0)
            .sort((a, b) => b[1][sub] - a[1][sub])
            .slice(0, 5)
            .map(([name, data], index) => `
                <div style="padding:8px 0; border-bottom:1px dashed #eee">
                    <span style="color:var(--pink)">${index + 1}.</span> ${name}
                    <span style="float:right; color:#666">${data[sub]}次</span>
                </div>
            `).join('');
        
        return `
        <div class="rank-section">
            <h3 style="color:var(--blue); margin:10px 0 5px">${sub}未交榜（累计）</h3>
            ${list || '<div style="color:#aaa; padding:8px 0">✅ 全员按时完成</div>'}
        </div>`;
    }).join('');
}

// ========== 通用功能 ==========
function refreshAll() {
    document.getElementById('subjectPopup').style.display = 'none';
    renderStudents();
    renderRanking();
}

document.addEventListener('click', (e) => {
    if (e.target.id === 'subjectPopup') {
        document.getElementById('subjectPopup').style.display = 'none';
    }
});
</script>
</body>
</html>
