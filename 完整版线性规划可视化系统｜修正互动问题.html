<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>çº¿æ€§è§„åˆ’æ•™å­¦å¯è§†åŒ–ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body { 
            font-family: 'Microsoft YaHei', sans-serif; 
            margin: 0; 
            padding: 0;
            background: #f0f2f5; 
        }
        
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .app-header {
            background: #1890ff;
            color: white;
            padding: 15px 20px;
            border-radius: 8px 8px 0 0;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .app-header h2 {
            margin: 0;
            font-size: 22px;
        }
        
        .app-content {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 20px;
        }
        
        .task-navigator {
            background: white;
            border-radius: 8px;
            padding: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .task-header {
            background: #f9f9f9;
            padding: 12px 20px;
            font-weight: bold;
            border-bottom: 1px solid #eee;
        }
        
        .task-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }
        
        .task-item {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background 0.3s;
        }
        
        .task-item:hover {
            background: #f5f5f5;
        }
        
        .task-item.active {
            background: #e6f7ff;
            border-left: 3px solid #1890ff;
        }
        
        .task-item .task-number {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-weight: bold;
            font-size: 14px;
        }
        
        .task-item.active .task-number {
            background: #1890ff;
            color: white;
        }
        
        .task-item .task-title {
            font-weight: 500;
        }
        
        .task-item .task-status {
            margin-left: auto;
            font-size: 14px;
            color: #999;
        }
        
        .task-item.completed .task-status {
            color: #52c41a;
        }
        
        .module-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        
        .module-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .module-header h3 {
            margin: 0;
            color: #222;
        }
        
        .task-content {
            display: none;
        }
        
        .task-content.active {
            display: block;
        }
        
        .chart-container {
            height: 600px;
            border-radius: 8px;
            overflow: visible; /* ä»hiddenæ”¹ä¸ºvisibleï¼Œç¡®ä¿å›¾è¡¨å†…å®¹ä¸è¢«è£å‰ª */
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            position: relative;
            z-index: 10; /* ç¡®ä¿å›¾è¡¨ä¼˜å…ˆçº§é«˜ */
            background: white;
            margin-bottom: 20px;
        }
        
        #chart {
            width: 100%;
            height: 100%;
            min-height: 500px; /* è®¾ç½®æœ€å°é«˜åº¦ç¡®ä¿å›¾è¡¨å¯è§ */
            position: relative;
            z-index: 15; /* ç¡®ä¿å›¾è¡¨å†…å®¹åœ¨æœ€ä¸Šå±‚ */
        }
        
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
        }
        
        /* ç¾åŒ–ç°æœ‰ç»„ä»¶ */
        .food-selection {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        .food-chip {
            padding: 8px 15px;
            font-size: 14px;
            border-radius: 20px;
            background: #f0f0f0;
            cursor: pointer;
            transition: all 0.3s;
            user-select: none;
        }
        
        .food-chip:hover {
            background: #e6f7ff;
        }
        
        .food-chip.selected {
            background: #1890ff;
            color: white;
        }
        
        input[type="range"] {
            height: 6px;
            border-radius: 3px;
            width: 100%;
            max-width: 350px;
        }
        
        input[type="number"] {
            width: 70px;
            padding: 6px 8px;
            border-radius: 4px;
            border: 1px solid #d9d9d9;
        }
        
        select {
            padding: 10px 12px;
            font-size: 15px;
            border-radius: 4px;
            border: 1px solid #d9d9d9;
            min-width: 200px;
        }
        
        .equation-panel, .food-data-panel {
            margin-top: 20px;
            border-radius: 8px;
            background: #f9f9f9;
            padding: 15px;
        }
        
        .math-eq {
            padding: 12px;
            font-family: "Times New Roman", serif;
            font-style: italic;
        }
        
        /* æ–°å¢ï¼šæ•™å­¦æŒ‡å¯¼æŒ‰é’®å’Œé¢æ¿æ ·å¼ */
        .tutorial-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #1890ff;
            color: white;
            font-size: 24px;
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 1000;
            transition: transform 0.3s, background 0.3s;
        }
        
        .tutorial-btn:hover {
            background: #40a9ff;
            transform: scale(1.1);
        }
        
        .tutorial-panel {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 400px;
            max-height: 500px;
            overflow-y: auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 3px 20px rgba(0,0,0,0.15);
            padding: 20px;
            z-index: 999;
            display: none;
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .tutorial-panel h3 {
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            color: #1890ff;
        }
        
        .tutorial-step {
            display: none;
            margin-bottom: 15px;
        }
        
        .tutorial-step.active {
            display: block;
            animation: fadeIn 0.4s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .tutorial-step h4 {
            margin-top: 0;
            color: #333;
        }
        
        .tutorial-step p {
            color: #666;
            line-height: 1.6;
        }
        
        .tutorial-step button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            margin-right: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .tutorial-step button:hover {
            background: #40a9ff;
        }
        
        /* é€šç”¨æŒ‰é’®æ ·å¼ */
        button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        button:hover {
            background: #40a9ff;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(24, 144, 255, 0.3);
        }
        
        button:disabled {
            background: #d9d9d9;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* ç»“æœé¢æ¿æ ·å¼ */
        .result-panel {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            transition: all 0.3s;
            font-size: 13px;
            position: absolute;
            right: 20px;
            top: 20px;
            max-width: 250px;
            z-index: 20; /* ç¡®ä¿ç»“æœé¢æ¿åœ¨å›¾è¡¨ä¸Šæ–¹ä½†ä¸å®Œå…¨é®æŒ¡ */
            border: 1px solid #e8e8e8;
            background-color: rgba(255, 255, 255, 0.95); /* åŠé€æ˜èƒŒæ™¯ */
        }
        
        .result-panel h3 {
            margin-top: 0;
            color: #1890ff;
            font-size: 16px;
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 8px;
            margin-bottom: 8px;
        }
        
        .result-panel p {
            margin: 6px 0;
            line-height: 1.5;
        }
        
        .result-panel p b {
            color: #333;
        }
        
        /* åŠ è½½æç¤ºæ ·å¼ */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            z-index: 100;
            font-size: 14px;
            display: none;
        }
        
        /* é£Ÿå“è¡¨æ ¼æ ·å¼ */
        .food-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .food-table th, .food-table td {
            padding: 10px;
            border: 1px solid #f0f0f0;
            text-align: center;
        }
        
        .food-table th {
            background: #f9f9f9;
            font-weight: 500;
        }
        
        .food-table tr {
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .food-table tr:hover {
            background: #f5f5f5;
        }
        
        .food-table tr.selected {
            background: #e6f7ff;
        }
        
        /* ä¼˜åŒ–æ§åˆ¶é¢æ¿æ ·å¼ */
        .control-item {
            margin-bottom: 15px;
            max-width: 350px;
        }
        
        .control-item label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .slider-container input[type="range"] {
            flex: 1;
        }
        
        /* é¢æ¿é«˜äº®æ•ˆæœ */
        .highlight-update {
            animation: panel-flash 0.6s;
        }
        
        @keyframes panel-flash {
            0% { box-shadow: 0 0 0 rgba(24, 144, 255, 0); }
            30% { box-shadow: 0 0 20px rgba(24, 144, 255, 0.8); background-color: #e6f7ff; }
            100% { box-shadow: 0 0 0 rgba(24, 144, 255, 0); }
        }
        
        /* æç¤ºæ ‡ç­¾ */
        .tip-label {
            background: #ffe58f;
            color: #874d00;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            margin-left: 5px;
            vertical-align: middle;
        }
        
        /* é¢æ¿åº•éƒ¨æç¤º */
        .panel-tip {
            margin-top: 10px;
            padding-top: 5px;
            border-top: 1px dashed #f0f0f0;
            font-size: 11px;
            color: #888;
            font-style: italic;
        }
    </style>
</head>
<body>
<div class="app-container">
    <div class="app-header">
        <h2>ğŸš€ çº¿æ€§è§„åˆ’æ•™å­¦å¯è§†åŒ–ç³»ç»Ÿ</h2>
    </div>
    
    <div class="app-content">
        <div class="controls-column">
            <!-- ä»»åŠ¡å¯¼èˆª -->
            <div class="task-navigator">
                <div class="task-header">å­¦ä¹ ä»»åŠ¡</div>
                <ul class="task-list">
                    <li id="task1" class="task-item active">
                        <div class="task-number">1</div>
                        <div class="task-title">åˆè¯†çº¿æ€§è§„åˆ’</div>
                        <div class="task-status">è¿›è¡Œä¸­</div>
                    </li>
                    <li id="task2" class="task-item">
                        <div class="task-number">2</div>
                        <div class="task-title">è®¾ç½®çº¦æŸæ¡ä»¶</div>
                        <div class="task-status">å¾…å®Œæˆ</div>
                    </li>
                    <li id="task3" class="task-item">
                        <div class="task-number">3</div>
                        <div class="task-title">è®¾å®šä¼˜åŒ–ç›®æ ‡</div>
                        <div class="task-status">å¾…å®Œæˆ</div>
                    </li>
                    <li id="task4" class="task-item">
                        <div class="task-number">4</div>
                        <div class="task-title">å¯è¡ŒåŸŸæ¢ç´¢</div>
                        <div class="task-status">å¾…å®Œæˆ</div>
                    </li>
                    <li id="task5" class="task-item">
                        <div class="task-number">5</div>
                        <div class="task-title">å¯»æ‰¾æœ€ä¼˜è§£</div>
                        <div class="task-status">å¾…å®Œæˆ</div>
                    </li>
                </ul>
        </div>

            <!-- åŠŸèƒ½æ¨¡å—ï¼Œæ ¹æ®ä»»åŠ¡æ˜¾ç¤º/éšè— -->
            <div id="intro-module" class="module-container">
                <div class="module-header">
                    <h3>ğŸ² é—®é¢˜ä»‹ç»</h3>
                </div>
                <p>çº¿æ€§è§„åˆ’é—®é¢˜æ˜¯å¯»æ‰¾æ»¡è¶³ä¸€ç»„çº¦æŸæ¡ä»¶ä¸‹çš„æœ€ä¼˜è§£ã€‚æœ¬ç³»ç»Ÿæ¨¡æ‹Ÿäº†é›¶é£Ÿè´­ä¹°å†³ç­–ï¼š</p>
                <ul>
                    <li>åœ¨é¢„ç®—é™åˆ¶ä¸‹</li>
                    <li>åœ¨çƒ­é‡é™åˆ¶ä¸‹</li>
                    <li>å¯»æ‰¾æœ€ä¼˜çš„é›¶é£Ÿè´­ä¹°æ–¹æ¡ˆ</li>
                </ul>
                <p>é˜…è¯»å®Œä»‹ç»åï¼Œè¯·åœ¨ä¸‹æ–¹é€‰æ‹©ä¸¤ç§é›¶é£Ÿè¿›è¡Œä¼˜åŒ–åˆ†æã€‚</p>
            </div>

            <div id="food-selection-module" class="module-container">
                <div class="module-header">
                    <h3>ğŸ¥ª é€‰æ‹©é›¶é£Ÿ</h3>
                </div>
                <p>é€‰æ‹©ä¸¤ç§é›¶é£Ÿè¿›è¡Œä¼˜åŒ–åˆ†æï¼š</p>
                <div class="food-selection">
                    <!-- é›¶é£Ÿé€‰æ‹©åŒºåŸŸç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div class="button-group">
                    <button onclick="confirmFoodSelection()" style="background:#52c41a;">ç¡®è®¤é€‰æ‹©</button>
                    <button onclick="resetFoodSelection()" style="background:#ff4d4f;">é‡ç½®é€‰æ‹©</button>
                    <button id="next-task-btn" onclick="nextTask()" style="background:#1890ff; display:none;">ç»§ç»­ä¸‹ä¸€æ­¥</button>
                </div>
            </div>

            <div id="constraint-module" class="module-container" style="display:none">
                <div class="module-header">
                    <h3>ğŸ”§ çº¦æŸæ¡ä»¶è®¾ç½®</h3>
                </div>
                <p>è°ƒæ•´ä»¥ä¸‹æ»‘å—æ¥è®¾ç½®ä¸åŒçš„é¢„ç®—å’Œçƒ­é‡çº¦æŸï¼š</p>
                <div class="control-item">
                    <label for="budget">é¢„ç®—çº¦æŸï¼ˆå…ƒï¼‰</label>
                    <div class="slider-container">
                        <input type="range" id="budget" min="10" max="100" value="30" oninput="updateBudget(this.value)">
                        <input type="number" id="budgetInput" min="10" max="100" value="30" onchange="updateBudget(this.value)">
                    </div>
                </div>
                
                <div class="control-item">
                    <label for="calorie">çƒ­é‡ä¸Šé™ï¼ˆåƒå¡ï¼‰</label>
                    <div class="slider-container">
                        <input type="range" id="calorie" min="300" max="2000" value="800" oninput="updateCalorie(this.value)">
                        <input type="number" id="calorieInput" min="300" max="2000" value="800" onchange="updateCalorie(this.value)">
                    </div>
                </div>
                <div class="button-group">
                    <button onclick="prevTask()">è¿”å›ä¸Šä¸€æ­¥</button>
                    <button onclick="nextTask()" style="background:#52c41a;">ç»§ç»­ä¸‹ä¸€æ­¥</button>
                </div>
            </div>
            
            <!-- ä¼˜åŒ–ç›®æ ‡æ¨¡å— -->
            <div id="objective-module" class="module-container" style="display:none">
                <div class="module-header">
                    <h3>ğŸ¯ è®¾å®šä¼˜åŒ–ç›®æ ‡</h3>
                </div>
                <p>é€‰æ‹©æ‚¨æƒ³è¦ä¼˜åŒ–çš„ç›®æ ‡ï¼š</p>
                <div class="control-item">
                    <select id="objective" onchange="updateUI()">
                        <option value="maxCalorie">æœ€å¤§åŒ–çƒ­é‡</option>
                        <option value="minCost">æœ€å°åŒ–æˆæœ¬</option>
                        <option value="maxNutrition">æœ€å¤§åŒ–è¥å…»</option>
            </select>
                </div>
                <p>ä¼˜åŒ–ç›®æ ‡å°†å†³å®šæœ€ä¼˜è§£çš„é€‰æ‹©æ ‡å‡†ã€‚</p>
                <div class="button-group">
                    <button onclick="prevTask()">è¿”å›ä¸Šä¸€æ­¥</button>
                    <button onclick="nextTask()" style="background:#52c41a;">ç»§ç»­ä¸‹ä¸€æ­¥</button>
                </div>
        </div>

            <!-- å¯è¡ŒåŸŸåˆ†ææ¨¡å— -->
            <div id="feasible-region-module" class="module-container" style="display:none">
                <div class="module-header">
                    <h3>ğŸ—ºï¸ å¯è¡ŒåŸŸåˆ†æ</h3>
            </div>
                <p>å¯è¡ŒåŸŸæ˜¯æ»¡è¶³æ‰€æœ‰çº¦æŸæ¡ä»¶çš„åŒºåŸŸï¼ˆå›¾ä¸­ç»¿è‰²åŒºåŸŸï¼‰ã€‚</p>
                <p>å¯è¡ŒåŸŸçš„é¡¶ç‚¹æ˜¯æ‰¾å‡ºæœ€ä¼˜è§£çš„å…³é”®ã€‚</p>
                <div class="button-group">
                    <button onclick="toggleVertex()" id="vertexBtn">ğŸ§­ æ˜¾ç¤ºé¡¶ç‚¹åæ ‡</button>
                    <button onclick="prevTask()">è¿”å›ä¸Šä¸€æ­¥</button>
                    <button onclick="nextTask()" style="background:#52c41a;">ç»§ç»­ä¸‹ä¸€æ­¥</button>
        </div>
    </div>

            <!-- æœ€ä¼˜è§£åˆ†ææ¨¡å— -->
            <div id="optimal-solution-module" class="module-container" style="display:none">
                <div class="module-header">
                    <h3>ğŸ† æœ€ä¼˜è§£åˆ†æ</h3>
                </div>
                <p>çº¿æ€§è§„åˆ’çš„åŸºæœ¬åŸç†ï¼šæœ€ä¼˜è§£æ€»æ˜¯å‡ºç°åœ¨å¯è¡ŒåŸŸçš„é¡¶ç‚¹ä¸Šã€‚</p>
                <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼Œè§‚å¯Ÿç³»ç»Ÿå¦‚ä½•æ£€éªŒæ¯ä¸ªé¡¶ç‚¹ï¼Œæ‰¾å‡ºæœ€ä¼˜è§£ã€‚</p>
                <div class="button-group">
                    <button id="animateBtn" onclick="startAnimation()">â–¶ï¸ å¼€å§‹é¡¶ç‚¹æ£€éªŒ</button>
                    <button onclick="prevTask()">è¿”å›ä¸Šä¸€æ­¥</button>
                    <button onclick="markTaskCompleted(4)" style="background:#52c41a;">å®Œæˆå­¦ä¹ </button>
                </div>
            </div>
            
            <!-- æ§åˆ¶é¢æ¿ - åœ¨æœ€åä¸€ä¸ªä»»åŠ¡ä¸­æ˜¾ç¤º -->
            <div id="controlPanel" class="module-container" style="display:none">
                <div class="module-header">
                    <h3>ğŸ® æ§åˆ¶é¢æ¿</h3>
                </div>
                
                <div class="control-item">
                    <label for="budget">é¢„ç®—çº¦æŸ</label>
                    <div class="slider-container">
                        <input type="range" id="budget-control" min="10" max="100" value="30" oninput="updateBudget(this.value)">
                        <input type="number" id="budgetInput-control" min="10" max="100" value="30" onchange="updateBudget(this.value)">
                    </div>
                </div>
                
                <div class="control-item">
                    <label for="calorie">çƒ­é‡ä¸Šé™</label>
                    <div class="slider-container">
                        <input type="range" id="calorie-control" min="300" max="2000" value="800" oninput="updateCalorie(this.value)">
                        <input type="number" id="calorieInput-control" min="300" max="2000" value="800" onchange="updateCalorie(this.value)">
                    </div>
                </div>
                
                <div class="control-item">
                    <label for="objective-control">ä¼˜åŒ–ç›®æ ‡</label>
                    <select id="objective-control" onchange="updateUI()">
                        <option value="maxCalorie">æœ€å¤§åŒ–çƒ­é‡</option>
                        <option value="minCost">æœ€å°åŒ–æˆæœ¬</option>
                        <option value="maxNutrition">æœ€å¤§åŒ–è¥å…»</option>
                    </select>
                </div>
                
                <div class="button-group">
                    <button id="vertexBtn-control" onclick="toggleVertex()">ğŸ§­ æ˜¾ç¤ºé¡¶ç‚¹åæ ‡</button>
                    <button id="animateBtn-control" onclick="startAnimation()">â–¶ï¸ å¼€å§‹é¡¶ç‚¹æ£€éªŒ</button>
                    <button id="objectiveLineBtn" onclick="toggleObjectiveLine()">æ˜¾ç¤ºç›®æ ‡å‡½æ•°çº¿</button>
                </div>
            </div>
        </div>
        
        <div class="visualization-column">
            <!-- å›¾è¡¨å®¹å™¨ -->
            <div id="chart-container" class="chart-container">
    <div id="chart"></div>
                <div class="loading" id="loadingTip">åŠ è½½ä¸­...</div>
                
                <!-- æ·»åŠ ä¸‰ç§çº§åˆ«çš„ç»“æœé¢æ¿ -->
                <div id="result-panel-basic" class="result-panel" style="display:none;">
                    <h3>åŸºæœ¬ä¿¡æ¯</h3>
                    <div id="resultContent-basic"></div>
                </div>

                <div id="result-panel-objective" class="result-panel" style="display:none; position: absolute; right: 20px; top: 70px; width: 250px; z-index: 100; background: rgba(255,255,255,0.9);">
                    <h3>ä¼˜åŒ–ç›®æ ‡ä¿¡æ¯</h3>
                    <div id="resultContent-objective"></div>
                </div>

                <div id="result-panel-full" class="result-panel" style="display:none; position: absolute; right: 20px; top: 70px; width: 250px; z-index: 100; background: rgba(255,255,255,0.9);">
                    <h3>æœ€ä¼˜è§£åˆ†æ</h3>
                    <div id="resultContent-full"></div>
                </div>
            </div>
            
            <!-- ä»»åŠ¡å†…å®¹åŒº -->
            <div id="content-task1" class="task-content active">
                <div class="module-container">
                    <div class="module-header">
                        <h3>ä»»åŠ¡1ï¼šåˆè¯†çº¿æ€§è§„åˆ’</h3>
                    </div>
                    <p>åœ¨è¿™ä¸ªä»»åŠ¡ä¸­ï¼Œæ‚¨å°†äº†è§£çº¿æ€§è§„åˆ’é—®é¢˜çš„åŸºæœ¬æ¦‚å¿µï¼Œå¹¶é€‰æ‹©ä¸¤ç§é›¶é£Ÿä½œä¸ºç ”ç©¶å¯¹è±¡ã€‚</p>
                    <ol>
                        <li>é˜…è¯»é—®é¢˜ä»‹ç»ï¼Œäº†è§£çº¿æ€§è§„åˆ’çš„æ¦‚å¿µ</li>
                        <li>ä»é›¶é£Ÿåˆ—è¡¨ä¸­é€‰æ‹©ä¸¤ç§æ‚¨æ„Ÿå…´è¶£çš„é›¶é£Ÿ</li>
                        <li>ç‚¹å‡»"ç¡®è®¤é€‰æ‹©"æŒ‰é’®ç¡®è®¤æ‚¨çš„é€‰æ‹©</li>
                    </ol>
                </div>
            </div>
            
            <!-- ä»»åŠ¡2å†…å®¹ -->
            <div id="content-task2" class="task-content">
                <div class="module-container">
                    <div class="module-header">
                        <h3>ä»»åŠ¡2ï¼šè®¾ç½®çº¦æŸæ¡ä»¶</h3>
                    </div>
                    <p>åœ¨è¿™ä¸ªä»»åŠ¡ä¸­ï¼Œæ‚¨å°†å­¦ä¹ å¦‚ä½•è®¾ç½®çº¿æ€§è§„åˆ’é—®é¢˜çš„çº¦æŸæ¡ä»¶ã€‚</p>
                    <ol>
                        <li>ä½¿ç”¨å·¦ä¾§æ»‘å—è°ƒæ•´é¢„ç®—çº¦æŸï¼ˆ${products.food1.price}x + ${products.food2.price}y â‰¤ é¢„ç®—å€¼ï¼‰</li>
                        <li>ä½¿ç”¨å·¦ä¾§æ»‘å—è°ƒæ•´çƒ­é‡çº¦æŸï¼ˆ${products.food1.calorie}x + ${products.food2.calorie}y â‰¤ çƒ­é‡ä¸Šé™ï¼‰</li>
                        <li>è§‚å¯Ÿå³ä¸Šè§’ç»“æœé¢æ¿å’Œå›¾è¡¨ä¸­å¯è¡ŒåŸŸçš„å˜åŒ–</li>
                    </ol>
                    <p>æç¤ºï¼šè¯•ç€è°ƒæ•´çº¦æŸæ¡ä»¶ï¼Œä½¿å¯è¡ŒåŸŸå˜å¤§æˆ–å˜å°ã€‚è§‚å¯Ÿå›¾è¡¨å³ä¸Šè§’çš„é¢æ¿ä»¥äº†è§£å½“å‰çŠ¶æ€ã€‚</p>
                </div>
            </div>
            
            <!-- æ›´æ–°ä»»åŠ¡3å†…å®¹ -->
            <div id="content-task3" class="task-content">
                <div class="module-container">
                    <div class="module-header">
                        <h3>ä»»åŠ¡3ï¼šè®¾å®šä¼˜åŒ–ç›®æ ‡</h3>
                    </div>
                    <p>åœ¨è¿™ä¸ªä»»åŠ¡ä¸­ï¼Œæ‚¨å°†å­¦ä¹ å¦‚ä½•è®¾å®šçº¿æ€§è§„åˆ’é—®é¢˜çš„ä¼˜åŒ–ç›®æ ‡ã€‚</p>
                    <ol>
                        <li>ä»å·¦ä¾§ä¸‹æ‹‰èœå•ä¸­é€‰æ‹©ä¸åŒçš„ä¼˜åŒ–ç›®æ ‡</li>
                        <li>å¯ä»¥å°è¯•ä¸‰ç§ä¸åŒçš„ç›®æ ‡ï¼šæœ€å¤§åŒ–çƒ­é‡ã€æœ€å°åŒ–æˆæœ¬ã€æœ€å¤§åŒ–è¥å…»</li>
                        <li>è§‚å¯Ÿå³ä¸Šè§’ç»“æœé¢æ¿ä¸­çš„ä¿¡æ¯å˜åŒ–</li>
                    </ol>
                    <p>æ€è€ƒï¼šä¸åŒçš„ä¼˜åŒ–ç›®æ ‡ä¼šå¦‚ä½•å½±å“æˆ‘ä»¬æœ€ç»ˆçš„å†³ç­–ï¼Ÿ</p>
                </div>
            </div>
            
            <!-- æ›´æ–°ä»»åŠ¡4å†…å®¹ -->
            <div id="content-task4" class="task-content">
                <div class="module-container">
                    <div class="module-header">
                        <h3>ä»»åŠ¡4ï¼šå¯è¡ŒåŸŸæ¢ç´¢</h3>
                    </div>
                    <p>åœ¨è¿™ä¸ªä»»åŠ¡ä¸­ï¼Œæ‚¨å°†æ·±å…¥äº†è§£å¯è¡ŒåŸŸçš„ç‰¹æ€§ã€‚</p>
                    <ol>
                        <li>ç‚¹å‡»å·¦ä¾§"æ˜¾ç¤ºé¡¶ç‚¹åæ ‡"æŒ‰é’®æŸ¥çœ‹å¯è¡ŒåŸŸçš„é¡¶ç‚¹</li>
                        <li>ä»”ç»†è§‚å¯Ÿè¿™äº›é¡¶ç‚¹çš„ä½ç½®å’Œåæ ‡</li>
                        <li>å°è¯•è°ƒæ•´çº¦æŸæ¡ä»¶ï¼Œè§‚å¯Ÿé¡¶ç‚¹å¦‚ä½•å˜åŒ–</li>
                    </ol>
                    <p><b>é‡è¦æ¦‚å¿µ</b>ï¼šçº¿æ€§è§„åˆ’çš„å…³é”®åŸç†æ˜¯æœ€ä¼˜è§£æ€»æ˜¯å‡ºç°åœ¨å¯è¡ŒåŸŸçš„é¡¶ç‚¹ä¸Šã€‚è¿™æ„å‘³ç€æˆ‘ä»¬åªéœ€è¦æ£€æŸ¥æ‰€æœ‰é¡¶ç‚¹ï¼Œå°±èƒ½æ‰¾åˆ°æœ€ä¼˜è§£ã€‚</p>
                </div>
            </div>
            
            <!-- æ›´æ–°ä»»åŠ¡5å†…å®¹ -->
            <div id="content-task5" class="task-content">
                <div class="module-container">
                    <div class="module-header">
                        <h3>ä»»åŠ¡5ï¼šå¯»æ‰¾æœ€ä¼˜è§£</h3>
                    </div>
                    <p>åœ¨è¿™ä¸ªä»»åŠ¡ä¸­ï¼Œæ‚¨å°†äº†è§£å¦‚ä½•åœ¨å¯è¡ŒåŸŸçš„é¡¶ç‚¹ä¸­æ‰¾å‡ºæœ€ä¼˜è§£ã€‚</p>
                    <ol>
                        <li>ç¡®ä¿å·²æ˜¾ç¤ºé¡¶ç‚¹åæ ‡</li>
                        <li>ç‚¹å‡»å·¦ä¾§"å¼€å§‹é¡¶ç‚¹æ£€éªŒ"æŒ‰é’®</li>
                        <li>è§‚å¯Ÿç³»ç»Ÿå¦‚ä½•é€ä¸€æ£€éªŒæ¯ä¸ªé¡¶ç‚¹ï¼Œæœ€ç»ˆæ‰¾å‡ºæœ€ä¼˜è§£</li>
                        <li>æŸ¥çœ‹å³ä¸Šè§’ç»“æœé¢æ¿ä¸­çš„è¯¦ç»†ä¿¡æ¯</li>
                    </ol>
                    <p>æ¢ç´¢ï¼šæ‚¨èƒ½å¦é¢„æµ‹æœ€ä¼˜è§£å°†å‡ºç°åœ¨å“ªä¸ªé¡¶ç‚¹ï¼Ÿç„¶åç‚¹å‡»"å¼€å§‹é¡¶ç‚¹æ£€éªŒ"éªŒè¯æ‚¨çš„çŒœæƒ³ã€‚</p>
                </div>
            </div>
            
            <!-- æ•°å­¦æ¨¡å‹æ˜¾ç¤ºé¢æ¿ -->
            <div id="equation-module" class="module-container" style="display:none">
                <div class="module-header">
                    <h3>ğŸ“Š æ•°å­¦æ¨¡å‹</h3>
                </div>
                <div class="equation-panel">
                    <p><b>å˜é‡å®šä¹‰ï¼š</b></p>
                    <p>x: <span id="var1Name">ç‰›å¥¶</span>çš„æ•°é‡</p>
                    <p>y: <span id="var2Name">é¢åŒ…</span>çš„æ•°é‡</p>
                    
                    <p><b>çº¦æŸæ¡ä»¶ï¼š</b></p>
                    <div class="math-eq" id="budgetEq">5x + 3y â‰¤ 30 (é¢„ç®—çº¦æŸ)</div>
                    <div class="math-eq" id="calorieEq">120x + 220y â‰¤ 800 (çƒ­é‡çº¦æŸ)</div>
                    <div class="math-eq">x â‰¥ 0, y â‰¥ 0 (éè´Ÿçº¦æŸ)</div>
                    
                    <p><b>ç›®æ ‡å‡½æ•°ï¼š</b></p>
                    <div class="math-eq" id="objectiveEq">æœ€å¤§åŒ– Z = 120x + 220y (æœ€å¤§åŒ–çƒ­é‡)</div>
                </div>
            </div>
            
            <!-- é£Ÿå“æ•°æ®è¡¨æ ¼ -->
            <div id="food-data-module" class="module-container" style="display:none">
                <div class="module-header">
                    <h3>ğŸ é›¶é£Ÿæ•°æ®</h3>
                </div>
                <div class="food-data-panel">
                    <table class="food-table">
                        <thead>
                            <tr>
                                <th>é›¶é£Ÿåç§°</th>
                                <th>ä»·æ ¼(å…ƒ)</th>
                                <th>çƒ­é‡(åƒå¡)</th>
                                <th>è¥å…»å¾—åˆ†</th>
                            </tr>
                        </thead>
                        <tbody id="foodTableBody">
                            <!-- è¡¨æ ¼å†…å®¹ä¼šé€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ•™å­¦æŒ‡å¯¼æŒ‰é’®å’Œé¢æ¿ -->
<button class="tutorial-btn" onclick="toggleTutorial()">?</button>
<div class="tutorial-panel" id="tutorialPanel">
    <h3>çº¿æ€§è§„åˆ’æ•™å­¦æŒ‡å—</h3>
    
    <div class="tutorial-step active" id="step1">
        <h4>ç¬¬ä¸€æ­¥ï¼šç†è§£é—®é¢˜èƒŒæ™¯</h4>
        <p>æœ¬ç³»ç»Ÿæ¨¡æ‹Ÿäº†ä¸€ä¸ªé›¶é£Ÿè´­ä¹°å†³ç­–é—®é¢˜ï¼š</p>
        <ul>
            <li>ç‰›å¥¶ï¼šæ¯ç›’5å…ƒï¼Œæä¾›120åƒå¡çƒ­é‡</li>
            <li>é¢åŒ…ï¼šæ¯ä¸ª3å…ƒï¼Œæä¾›220åƒå¡çƒ­é‡</li>
        </ul>
        <p>ç›®æ ‡æ˜¯åœ¨é¢„ç®—å’Œçƒ­é‡é™åˆ¶ä¸‹æ‰¾åˆ°æœ€ä¼˜è´­ä¹°æ–¹æ¡ˆã€‚</p>
        <button onclick="nextTutorialStep()">ä¸‹ä¸€æ­¥</button>
    </div>
    
    <div class="tutorial-step" id="step2">
        <h4>ç¬¬äºŒæ­¥ï¼šè®¾ç½®çº¦æŸæ¡ä»¶</h4>
        <p>çº¿æ€§è§„åˆ’é—®é¢˜ç”±çº¦æŸæ¡ä»¶å’Œç›®æ ‡å‡½æ•°ç»„æˆï¼š</p>
        <p><b>çº¦æŸæ¡ä»¶ï¼š</b></p>
        <ul>
            <li>é¢„ç®—çº¦æŸï¼š5x + 3y â‰¤ é¢„ç®—å€¼</li>
            <li>çƒ­é‡çº¦æŸï¼š120x + 220y â‰¤ çƒ­é‡ä¸Šé™</li>
            <li>éè´Ÿçº¦æŸï¼šx â‰¥ 0, y â‰¥ 0</li>
        </ul>
        <p>è°ƒæ•´æ»‘å—æ¥è®¾ç½®ä¸åŒçš„é¢„ç®—å’Œçƒ­é‡çº¦æŸã€‚</p>
        <button onclick="prevTutorialStep()">ä¸Šä¸€æ­¥</button>
        <button onclick="nextTutorialStep()">ä¸‹ä¸€æ­¥</button>
    </div>
    
    <div class="tutorial-step" id="step3">
        <h4>ç¬¬ä¸‰æ­¥ï¼šå¯è¡ŒåŸŸåˆ†æ</h4>
        <p>çº¦æŸæ¡ä»¶çš„äº¤é›†å½¢æˆ<b>å¯è¡ŒåŸŸ</b>ï¼ˆç»¿è‰²åŒºåŸŸï¼‰ã€‚æ¯ä¸ªçº¦æŸæ¡ä»¶åœ¨åæ ‡ç³»ä¸­è¡¨ç¤ºä¸ºä¸€æ¡ç›´çº¿ï¼š</p>
        <ul>
            <li>çº¢çº¿ï¼šé¢„ç®—çº¦æŸè¾¹ç•Œ</li>
            <li>è“çº¿ï¼šçƒ­é‡çº¦æŸè¾¹ç•Œ</li>
        </ul>
        <p>å¯è¡ŒåŸŸçš„é¡¶ç‚¹æ˜¯è¿™äº›çº¦æŸçº¿çš„äº¤ç‚¹ï¼ŒåŒ…æ‹¬ä¸åæ ‡è½´çš„äº¤ç‚¹ã€‚</p>
        <button onclick="prevTutorialStep()">ä¸Šä¸€æ­¥</button>
        <button onclick="nextTutorialStep()">ä¸‹ä¸€æ­¥</button>
    </div>
    
    <div class="tutorial-step" id="step4">
        <h4>ç¬¬å››æ­¥ï¼šæœ€ä¼˜è§£åˆ†æ</h4>
        <p>çº¿æ€§è§„åˆ’çš„åŸºæœ¬åŸç†ï¼šæœ€ä¼˜è§£æ€»æ˜¯å‡ºç°åœ¨å¯è¡ŒåŸŸçš„é¡¶ç‚¹ä¸Šã€‚</p>
        <p>ç‚¹å‡»"é¡¶ç‚¹åæ ‡æ˜¾ç¤º"æŸ¥çœ‹æ‰€æœ‰é¡¶ç‚¹ï¼Œç„¶åç‚¹å‡»"å¼€å§‹é¡¶ç‚¹æ£€éªŒ"æŸ¥çœ‹ç³»ç»Ÿå¦‚ä½•é€ä¸€æ£€éªŒæ¯ä¸ªé¡¶ç‚¹ï¼Œæ‰¾å‡ºæœ€ä¼˜è§£ã€‚</p>
        <button onclick="prevTutorialStep()">ä¸Šä¸€æ­¥</button>
        <button onclick="closeTutorial()">å®Œæˆå­¦ä¹ </button>
    </div>
</div>

<script>
// å…¨å±€å˜é‡
let myChart = null;
let animationTimer = null;
let animationSteps = [];
let currentStep = 0;
let showVertices = false;
let currentTutorialStep = 1;
let selectedFoods = [];
let customZoom = false;
let zoomFactor = { x: 1.3, y: 1.3 };
let showObjectiveLine = false;
let optimalZ = 0;

// é›¶é£Ÿæ•°æ®åº“
const foodDatabase = {
    ç‰›å¥¶: { price: 5, calorie: 120, nutrition: 12, color: '#5470c6' },
    é¢åŒ…: { price: 3, calorie: 220, nutrition: 8, color: '#91cc75' },
    æ°´æœå¹²: { price: 3, calorie: 300, nutrition: 8, color: '#fac858' },
    åšæœ: { price: 6, calorie: 550, nutrition: 10, color: '#ee6666' },
    å·§å…‹åŠ›æ£’: { price: 6, calorie: 700, nutrition: 8, color: '#73c0de' },
    è–¯ç‰‡: { price: 4, calorie: 550, nutrition: 3, color: '#3ba272' },
    æœå†»: { price: 2, calorie: 80, nutrition: 4, color: '#fc8452' },
    é¥¼å¹²: { price: 5, calorie: 400, nutrition: 6, color: '#9a60b4' }
};

// å½“å‰é€‰æ‹©çš„ä¸¤ç§é›¶é£Ÿ
let products = {
    food1: { name: 'ç‰›å¥¶', price: 5, calorie: 120, nutrition: 12, color: '#5470c6' },
    food2: { name: 'é¢åŒ…', price: 3, calorie: 220, nutrition: 8, color: '#91cc75' }
};

// ============== é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ– ==============
window.onload = function() {
    try {
        document.getElementById('loadingTip').style.display = 'block';
        
        // åˆ›å»ºé›¶é£Ÿé€‰æ‹©åŒºåŸŸ
        createFoodSelection();
        
        // åˆå§‹åŒ–é»˜è®¤é€‰ä¸­çš„é›¶é£Ÿ
        selectedFoods = ['ç‰›å¥¶', 'é¢åŒ…'];
        
        // åˆå§‹åŒ–å›¾è¡¨
        initChart();
        
        // å¡«å……é£Ÿå“è¡¨æ ¼
        fillFoodTable();
        
        // åˆå§‹åŒ–ä»»åŠ¡ç³»ç»Ÿ
        initTaskUI();
        
        // ç¡®ä¿ç»“æœé¢æ¿åˆå§‹ä¸æ˜¾ç¤º
        document.getElementById('result-panel-basic').style.display = 'none';
        document.getElementById('result-panel-objective').style.display = 'none';
        document.getElementById('result-panel-full').style.display = 'none';
        
        // æ›´æ–°UI
        updateUI();
        
        document.getElementById('loadingTip').style.display = 'none';
    } catch (e) {
        console.error("åˆå§‹åŒ–å‡ºé”™:", e);
        alert("åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•: " + e.message);
        document.getElementById('loadingTip').style.display = 'none';
    }
};

// åˆ›å»ºé›¶é£Ÿé€‰æ‹©åŒºåŸŸ
function createFoodSelection() {
    const foodSelectionDiv = document.querySelector('.food-selection');
    if (!foodSelectionDiv) return;
    
    // æ¸…ç©ºç°æœ‰å†…å®¹
    foodSelectionDiv.innerHTML = '';
    
    // ä¸ºæ¯ç§é›¶é£Ÿåˆ›å»ºé€‰æ‹©èŠ¯ç‰‡
    for (const [foodName, foodData] of Object.entries(foodDatabase)) {
        const chip = document.createElement('div');
        chip.className = 'food-chip';
        chip.textContent = foodName;
        chip.onclick = function() { selectFood(this, foodName); };
        
        // å¦‚æœæ˜¯é»˜è®¤é€‰ä¸­çš„é›¶é£Ÿï¼Œæ·»åŠ selectedç±»
        if (foodName === 'ç‰›å¥¶' || foodName === 'é¢åŒ…') {
            chip.classList.add('selected');
        }
        
        foodSelectionDiv.appendChild(chip);
    }
}

// ============== å®‰å…¨åˆå§‹åŒ–å›¾è¡¨ ==============
function initChart() {
    try {
        // å¦‚æœå·²å­˜åœ¨å›¾è¡¨å®ä¾‹ï¼Œå…ˆé”€æ¯
        if (myChart && myChart.dispose) {
            myChart.dispose();
        }
        
        // åˆ›å»ºæ–°å›¾è¡¨å®ä¾‹
        myChart = echarts.init(document.getElementById('chart'));
        
        // æ³¨å†Œçª—å£å¤§å°æ”¹å˜äº‹ä»¶
        window.addEventListener('resize', function() {
            if (myChart) {
                myChart.resize();
            }
        });
        
        return true;
    } catch (e) {
        console.error("åˆå§‹åŒ–å›¾è¡¨å¤±è´¥:", e);
        return false;
    }
}

// ============== æ ¸å¿ƒç®—æ³•ï¼šè®¡ç®—é¡¶ç‚¹ ==============
function calculateVertices(budget, calorie) {
    try {
        const points = [];
        
        // åŸç‚¹
        points.push({x: 0, y: 0});
        
        // è®¡ç®—é¢„ç®—çº¦æŸçº¿ä¸åæ ‡è½´çš„äº¤ç‚¹
        if (products.food1.price > 0) {
            const xMax = budget / products.food1.price;
            points.push({x: xMax, y: 0});
        }
        
        if (products.food2.price > 0) {
            const yMax = budget / products.food2.price;
            points.push({x: 0, y: yMax});
        }
        
        // è®¡ç®—çƒ­é‡çº¦æŸçº¿ä¸åæ ‡è½´çš„äº¤ç‚¹
        if (products.food1.calorie > 0) {
            const xMin = calorie / products.food1.calorie;
            points.push({x: xMin, y: 0});
        }
        
        if (products.food2.calorie > 0) {
            const yMin = calorie / products.food2.calorie;
            points.push({x: 0, y: yMin});
        }
        
        // è®¡ç®—ä¸¤çº¦æŸçº¿çš„äº¤ç‚¹
        const denominator = (products.food1.price * products.food2.calorie - 
                            products.food2.price * products.food1.calorie);
        
        if (denominator !== 0) {
            const x = (products.food2.calorie * budget - products.food2.price * calorie) / denominator;
            const y = (products.food1.price * calorie - products.food1.calorie * budget) / denominator;
            
            if (x >= 0 && y >= 0) {
                points.push({x: x, y: y});
            }
        }
        
        // éªŒè¯ç‚¹çš„æœ‰æ•ˆæ€§ï¼ˆéè´Ÿï¼‰å¹¶å»é‡
        const validPoints = points.filter(p => 
            p.x >= 0 && p.y >= 0 && 
            !isNaN(p.x) && !isNaN(p.y) && 
            p.x !== Infinity && p.y !== Infinity
        );
        
        // æ‰¾å‡ºæ»¡è¶³æ‰€æœ‰çº¦æŸçš„ç‚¹
        return validPoints.filter(p => {
            // æ£€æŸ¥é¢„ç®—çº¦æŸ
            const totalCost = p.x * products.food1.price + p.y * products.food2.price;
            const totalCalorie = p.x * products.food1.calorie + p.y * products.food2.calorie;
            return totalCost <= budget && totalCalorie <= calorie;
        });
    } catch (e) {
        console.error("è®¡ç®—é¡¶ç‚¹é”™è¯¯:", e);
        return [];
    }
}

// ============== é¡¶ç‚¹æ’åºï¼ˆé¡ºæ—¶é’ˆæ’åºï¼Œç”¨äºç»˜åˆ¶æ­£ç¡®çš„é—­åˆåŒºåŸŸï¼‰==============
function sortVerticesClockwise(vertices) {
    try {
        if (vertices.length <= 2) return vertices;
        
        // è®¡ç®—ä¸­å¿ƒç‚¹
        const center = vertices.reduce(
            (acc, v) => ({x: acc.x + v.x, y: acc.y + v.y}), 
            {x: 0, y: 0}
        );
        center.x /= vertices.length;
        center.y /= vertices.length;
        
        // æŒ‰è§’åº¦æ’åº
        return vertices.slice().sort((a, b) => {
            const angleA = Math.atan2(a.y - center.y, a.x - center.x);
            const angleB = Math.atan2(b.y - center.y, b.x - center.x);
            return angleA - angleB;
        });
    } catch (e) {
        console.error("é¡¶ç‚¹æ’åºé”™è¯¯:", e);
        return vertices;
    }
}

// ============== å®‰å…¨çš„UIæ›´æ–°å‡½æ•° ==============
function updateUI() {
    try {
        document.getElementById('loadingTip').style.display = 'block';
        
        // ç¡®ä¿åœ¨setTimeoutä¹‹å‰å®Œæˆä¸€äº›å¿…è¦çš„æ£€æŸ¥
        const budgetInput = document.getElementById('budgetInput');
        const calorieInput = document.getElementById('calorieInput');
        
        if (!budgetInput || !calorieInput) {
            console.error("æ‰¾ä¸åˆ°å¿…è¦çš„è¾“å…¥å…ƒç´ ï¼Œæ— æ³•æ›´æ–°UI");
            document.getElementById('loadingTip').style.display = 'none';
            return;
        }
        
        // ä½¿ç”¨setTimeoutç¡®ä¿UIäº‹ä»¶å¤„ç†å®Œæˆ
        setTimeout(() => {
            try {
                // åŒæ­¥æ§åˆ¶é¢æ¿å€¼
                syncControlValues();
                
                // æ›´æ–°å›¾è¡¨
                renderChart();
                
                // æ›´æ–°ç»“æœæ˜¾ç¤º
                updateResults();
                
                // æ›´æ–°æ•°å­¦æ¨¡å‹
                updateEquations();
            } catch (e) {
                console.error("æ›´æ–°UIé”™è¯¯:", e);
            } finally {
                document.getElementById('loadingTip').style.display = 'none';
            }
        }, 50);
    } catch (e) {
        console.error("æ›´æ–°UIå‡†å¤‡é˜¶æ®µé”™è¯¯:", e);
        document.getElementById('loadingTip').style.display = 'none';
    }
}

// ============== å›¾è¡¨æ¸²æŸ“å‡½æ•° ==============
function renderChart() {
    try {
        console.log("å¼€å§‹æ¸²æŸ“å›¾è¡¨...");
        
        // å®Œå…¨é‡æ–°åˆå§‹åŒ–å›¾è¡¨ï¼Œé¿å…çŠ¶æ€é—®é¢˜
        if (!myChart || !myChart.setOption) {
            console.log("å›¾è¡¨å®ä¾‹ä¸å­˜åœ¨æˆ–ä¸å®Œæ•´ï¼Œé‡æ–°åˆå§‹åŒ–");
            if (!initChart()) {
                console.error("é‡æ–°åˆå§‹åŒ–å›¾è¡¨å¤±è´¥");
                return false;
            }
        }
        
        // ç¡®ä¿å›¾è¡¨å®¹å™¨å¯è§
        const chartContainer = document.getElementById('chart-container');
        if (chartContainer) {
            chartContainer.style.display = 'block';
            chartContainer.style.height = '600px';
        }
        
        const chartDiv = document.getElementById('chart');
        if (chartDiv) {
            chartDiv.style.height = '600px';
        }
        
        // è·å–å‚æ•°
        const budget = parseFloat(document.getElementById('budgetInput').value) || 30;
        const calorie = parseFloat(document.getElementById('calorieInput').value) || 800;
        
        console.log(`æ¸²æŸ“å›¾è¡¨ï¼Œé¢„ç®—=${budget}, çƒ­é‡=${calorie}`);
        
        // è®¡ç®—é¡¶ç‚¹
    const vertices = calculateVertices(budget, calorie);
        console.log("è®¡ç®—é¡¶ç‚¹ç»“æœ:", vertices);

        // æ™ºèƒ½è®¡ç®—åæ ‡è½´èŒƒå›´
        let maxX = 10, maxY = 10; // è®¾ç½®é»˜è®¤å€¼ï¼Œç¡®ä¿å›¾è¡¨å§‹ç»ˆæ˜¾ç¤º
        
        if (vertices.length > 0) {
            // æœ‰é¡¶ç‚¹æ—¶åŸºäºé¡¶ç‚¹è°ƒæ•´èŒƒå›´
            if (customZoom) {
                // ä½¿ç”¨è‡ªå®šä¹‰ç¼©æ”¾
                maxX = Math.max(5, ...vertices.map(v => v.x || 0)) * zoomFactor.x;
                maxY = Math.max(5, ...vertices.map(v => v.y || 0)) * zoomFactor.y;
            } else {
                // è‡ªé€‚åº”ç¼©æ”¾
                const maxVertexX = Math.max(...vertices.map(v => v.x || 0));
                const maxVertexY = Math.max(...vertices.map(v => v.y || 0));
                
                let baseScale = 1.3;
                if (maxVertexX < 5 || maxVertexY < 5) {
                    baseScale = 2.0;
                }
                if (maxVertexX < 1 || maxVertexY < 1) {
                    baseScale = 3.0;
                }
                
                maxX = Math.max(Math.max(maxVertexX, 0.5) * baseScale, 5);
                maxY = Math.max(Math.max(maxVertexY, 0.5) * baseScale, 5);
                
                const ratio = maxX / maxY;
                if (ratio > 3) {
                    maxY = maxX / 3;
                } else if (ratio < 0.33) {
                    maxX = maxY / 3;
                }
            }
        }
        
        // åŸºç¡€é…ç½®
    const option = {
        title: { 
                text: 'çº¿æ€§è§„åˆ’å¯è§†åŒ–',
                subtext: `é¢„ç®—ï¼š${budget}å…ƒ | çƒ­é‡ä¸Šé™ï¼š${calorie}kcal`,
            left: 'center'
        },
            tooltip: {
                trigger: 'item',
                formatter: function(params) {
                    if (params.seriesName === 'å¯è¡ŒåŸŸ') return '';
                    if (params.seriesName === 'é¡¶ç‚¹åæ ‡' || params.seriesName === 'å½“å‰æ£€éªŒç‚¹') {
                        const x = params.value[0];
                        const y = params.value[1];
                        return `åæ ‡: (${x.toFixed(2)}, ${y.toFixed(2)})<br/>` +
                               `èŠ±è´¹: ${(x*products.food1.price + y*products.food2.price).toFixed(2)}å…ƒ<br/>` +
                               `çƒ­é‡: ${(x*products.food1.calorie + y*products.food2.calorie).toFixed(0)}åƒå¡`;
                    }
                    return params.seriesName;
                }
            },
            legend: {
                data: ['é¢„ç®—çº¦æŸ', 'çƒ­é‡çº¦æŸ', 'å¯è¡ŒåŸŸ', 'é¡¶ç‚¹åæ ‡'],
                bottom: 10
            },
            grid: {
                left: '10%',
                right: '10%',
                top: '15%',
                bottom: '15%',
                containLabel: true
        },
        xAxis: { 
                name: products.food1 ? `${products.food1.name}ï¼ˆä¸ªï¼‰` : "xè½´",
                nameLocation: 'middle',
                nameGap: 30,
            min: 0, 
                max: maxX,
                type: 'value',
                boundaryGap: false,
                axisLine: {
                    lineStyle: {
                        width: 2
                    }
                }
        },
        yAxis: { 
                name: products.food2 ? `${products.food2.name}ï¼ˆä¸ªï¼‰` : "yè½´",
                nameLocation: 'middle',
                nameGap: 30,
            min: 0, 
                max: maxY,
                type: 'value',
                axisLine: {
                    lineStyle: {
                        width: 2
                    }
                }
            },
            series: []
        };
        
        // 1. ç»˜åˆ¶é¢„ç®—çº¦æŸçº¿
        option.series.push({
            name: 'é¢„ç®—çº¦æŸ',
                type: 'line',
            symbol: 'none',
            data: [
                [0, budget / products.food2.price],
                [budget / products.food1.price, 0]
            ],
            lineStyle: {
                color: '#ff4d4f',
                width: 2
            }
        });
        
        // 2. ç»˜åˆ¶çƒ­é‡çº¦æŸçº¿
        option.series.push({
            name: 'çƒ­é‡çº¦æŸ',
                type: 'line',
            symbol: 'none',
            data: [
                [0, calorie / products.food2.calorie],
                [calorie / products.food1.calorie, 0]
            ],
            lineStyle: {
                color: '#1890ff',
                width: 2,
                type: 'dashed'
            }
        });
        
        // 3. ç»˜åˆ¶å¯è¡ŒåŸŸ
        if (vertices.length >= 3) {
            // éœ€è¦å¯¹é¡¶ç‚¹è¿›è¡Œæ’åºä»¥ä¾¿å½¢æˆæ­£ç¡®çš„åŒºåŸŸè¾¹ç•Œ
            const sortedVertices = sortVerticesClockwise(vertices);
            
            // æ·»åŠ ç¬¬ä¸€ä¸ªç‚¹ä½œä¸ºç»“æŸç‚¹ï¼Œå½¢æˆé—­åˆåŒºåŸŸ
            const areaData = [...sortedVertices.map(v => [v.x, v.y])];
            if (areaData.length > 0) {
                areaData.push(areaData[0]);
            }
            
            option.series.push({
                name: 'å¯è¡ŒåŸŸ',
                type: 'line',
                symbol: 'none',
                data: areaData,
                areaStyle: {
                    color: 'rgba(150, 230, 150, 0.3)'
                },
                lineStyle: {
                    color: '#95de64',
                    width: 1
                }
            });
        }
        
        // 4. å¦‚æœéœ€è¦ï¼Œç»˜åˆ¶é¡¶ç‚¹
        if (showVertices && vertices.length > 0) {
        option.series.push({
                name: 'é¡¶ç‚¹åæ ‡',
            type: 'scatter',
                symbol: 'circle',
                symbolSize: 10,
                data: vertices.map(v => [v.x, v.y]),
                itemStyle: {
                    color: '#722ed1'
                },
            label: {
                show: true,
                    formatter: function(params) {
                        return `(${parseFloat(params.value[0]).toFixed(1)},${parseFloat(params.value[1]).toFixed(1)})`;
                    },
                    position: 'top',
                    fontSize: 12,
                    color: '#333',
                    backgroundColor: 'rgba(255,255,255,0.8)',
                    padding: [2, 4],
                    borderRadius: 3
            }
        });
    }

        // 5. æ·»åŠ ç›®æ ‡å‡½æ•°çº¿
        if (showObjectiveLine) {
            // æ·»åŠ ç›®æ ‡å‡½æ•°çš„ä»£ç ...
            const objective = document.getElementById('objective').value;
            let slope, intercept;
            
            switch (objective) {
                case 'maxCalorie':
                    // ç›®æ ‡å‡½æ•° z = ax + byï¼Œç­‰å€¼çº¿æ–œç‡ä¸º -a/b
                    slope = -products.food1.calorie / products.food2.calorie;
                    break;
                case 'minCost':
                    slope = -products.food1.price / products.food2.price;
                    break;
                case 'maxNutrition':
                    slope = -products.food1.nutrition / products.food2.nutrition;
                    break;
            }
            
            // è®¡ç®—æœ€ä¼˜è§£
            const optimal = calculateVertices(budget, calorie).reduce((best, current) => {
                const cost = current.x * products.food1.price + current.y * products.food2.price;
                const calories = current.x * products.food1.calorie + current.y * products.food2.calorie;
                const nutrition = current.x * products.food1.nutrition + current.y * products.food2.nutrition;
                
                if (objective === 'maxCalorie') {
                    return calories > best.calories ? current : best;
                } else if (objective === 'minCost') {
                    return cost < best.cost ? current : best;
                } else {
                    return nutrition > best.nutrition ? current : best;
                }
            }, vertices[0]);
            
            const optimalZ = objective === 'maxCalorie' ? optimal.calories : objective === 'minCost' ? optimal.cost : optimal.nutrition;
            
            // åˆ›å»ºä¸åŒç›®æ ‡å‡½æ•°å€¼çš„ç­‰å€¼çº¿
            for (let i = 1; i <= 5; i++) {
                let zValue;
                if (objective === 'maxCalorie') {
                    zValue = optimalZ * (0.5 + i * 0.1); // æœ€ä¼˜å€¼çš„50%-100%
                } else if (objective === 'minCost') {
                    zValue = optimalZ * (1.5 - i * 0.1); // æœ€ä¼˜å€¼çš„150%-100%
                } else {
                    zValue = optimalZ * (0.5 + i * 0.1); // æœ€ä¼˜å€¼çš„50%-100%
                }
                
                // è®¡ç®—yæˆªè·
                intercept = zValue / products.food2.calorie;
                if (objective === 'minCost') {
                    intercept = zValue / products.food2.price;
                } else if (objective === 'maxNutrition') {
                    intercept = zValue / products.food2.nutrition;
                }
                
                // è®¡ç®—çº¿çš„ä¸¤ä¸ªç«¯ç‚¹
                const x1 = 0;
                const y1 = intercept;
                const x2 = -intercept / slope;
                const y2 = 0;
                
                option.series.push({
                    name: `ç›®æ ‡å‡½æ•°ç­‰å€¼çº¿${i}`,
                    type: 'line',
                    symbol: 'none',
                    data: [
                        [x1, y1],
                        [x2, y2]
                    ],
                    lineStyle: {
                        color: i === 5 ? '#ff7a45' : '#ffc53d',
                        width: i === 5 ? 2 : 1,
                        type: 'dotted',
                        opacity: 0.6 + i * 0.08
                    }
                });
            }
        }
        
        // 6. å¦‚æœæœ‰å½“å‰åŠ¨ç”»æ­¥éª¤ï¼Œæ˜¾ç¤ºåŠ¨ç”»ç‚¹
        if (currentStep < animationSteps.length && animationSteps[currentStep]) {
            const step = animationSteps[currentStep];
            option.series.push({
                name: 'å½“å‰æ£€éªŒç‚¹',
                type: 'effectScatter',
                symbol: 'circle',
                symbolSize: 20,
                data: [[step.vertex.x, step.vertex.y]],
                itemStyle: {
                    color: step.action === 'final' ? '#52c41a' : '#fa8c16'
                },
                rippleEffect: {
                    brushType: 'stroke',
                    scale: 3,
                    period: 2
                },
                zlevel: 10
            });
        }
        
        // è®¾ç½®é€‰é¡¹
        myChart.setOption(option, true);
        console.log("å›¾è¡¨æ¸²æŸ“æˆåŠŸ");
        return true;
    } catch (e) {
        console.error("æ¸²æŸ“å›¾è¡¨é”™è¯¯:", e);
        return false;
    }
}

// ============== åœæ­¢æ‰€æœ‰åŠ¨ç”» ==============
function stopAllAnimations() {
    if (animationTimer) {
        clearInterval(animationTimer);
        animationTimer = null;
    }
    
    document.getElementById('animateBtn').disabled = false;
    renderChart();
    updateResults();
}

// ============== æ˜¾ç¤º/éšè—é¡¶ç‚¹åæ ‡ ==============
function toggleVertex() {
    showVertices = !showVertices;
    document.getElementById('vertexBtn').innerText = showVertices ? 'ğŸ§­ éšè—é¡¶ç‚¹åæ ‡' : 'ğŸ§­ æ˜¾ç¤ºé¡¶ç‚¹åæ ‡';
    renderChart();
}

// ============== æ•™å­¦æŒ‡å¯¼å‡½æ•° ==============
function toggleTutorial() {
    const panel = document.getElementById('tutorialPanel');
    panel.style.display = panel.style.display === 'none' || panel.style.display === '' ? 'block' : 'none';
}

function nextTutorialStep() {
    if (currentTutorialStep < 4) {
        document.getElementById(`step${currentTutorialStep}`).classList.remove('active');
        currentTutorialStep++;
        document.getElementById(`step${currentTutorialStep}`).classList.add('active');
    }
}

function prevTutorialStep() {
    if (currentTutorialStep > 1) {
        document.getElementById(`step${currentTutorialStep}`).classList.remove('active');
        currentTutorialStep--;
        document.getElementById(`step${currentTutorialStep}`).classList.add('active');
    }
}

function closeTutorial() {
    document.getElementById('tutorialPanel').style.display = 'none';
}

// ============== é›¶é£Ÿé€‰æ‹©åŠŸèƒ½ ==============
function selectFood(element, foodName) {
    if (element.classList.contains('selected')) {
        // å–æ¶ˆé€‰æ‹©
        element.classList.remove('selected');
        selectedFoods = selectedFoods.filter(f => f !== foodName);
    } else {
        // æ–°é€‰æ‹©ï¼Œä½†é™åˆ¶æœ€å¤šé€‰æ‹©ä¸¤ç§
        if (selectedFoods.length < 2) {
            element.classList.add('selected');
            selectedFoods.push(foodName);
        } else {
            alert('æœ€å¤šåªèƒ½é€‰æ‹©ä¸¤ç§é›¶é£Ÿè¿›è¡Œä¼˜åŒ–ï¼');
        }
    }
}

function confirmFoodSelection() {
    if (selectedFoods.length !== 2) {
        alert('è¯·é€‰æ‹©ä¸¤ç§é›¶é£Ÿè¿›è¡Œä¼˜åŒ–ï¼');
        return;
    }
    
    // æ›´æ–°äº§å“æ•°æ®
    const food1 = selectedFoods[0];
    const food2 = selectedFoods[1];
    
    products = {
        food1: { 
            name: food1,
            price: foodDatabase[food1].price, 
            calorie: foodDatabase[food1].calorie, 
            nutrition: foodDatabase[food1].nutrition,
            color: foodDatabase[food1].color
        },
        food2: { 
            name: food2,
            price: foodDatabase[food2].price, 
            calorie: foodDatabase[food2].calorie, 
            nutrition: foodDatabase[food2].nutrition,
            color: foodDatabase[food2].color
        }
    };
    
    // æ›´æ–°UI
    alert(`å·²é€‰æ‹© ${food1} å’Œ ${food2} ä½œä¸ºä¼˜åŒ–å¯¹è±¡ï¼`);
    updateUI();
    fillFoodTable(); // æ›´æ–°è¡¨æ ¼é«˜äº®
    
    // æ˜¾ç¤º"ç»§ç»­ä¸‹ä¸€æ­¥"æŒ‰é’®
    document.getElementById('next-task-btn').style.display = 'inline-block';
}

function resetFoodSelection() {
    // é‡ç½®é€‰æ‹©çŠ¶æ€
    selectedFoods = [];
    document.querySelectorAll('.food-chip').forEach(chip => {
        chip.classList.remove('selected');
    });
    
    // æ¢å¤é»˜è®¤å•†å“
    products = {
        food1: { 
            name: 'ç‰›å¥¶',
            price: foodDatabase['ç‰›å¥¶'].price, 
            calorie: foodDatabase['ç‰›å¥¶'].calorie, 
            nutrition: foodDatabase['ç‰›å¥¶'].nutrition,
            color: foodDatabase['ç‰›å¥¶'].color
        },
        food2: { 
            name: 'é¢åŒ…',
            price: foodDatabase['é¢åŒ…'].price, 
            calorie: foodDatabase['é¢åŒ…'].calorie, 
            nutrition: foodDatabase['é¢åŒ…'].nutrition,
            color: foodDatabase['é¢åŒ…'].color
        }
    };
    
    // è‡ªåŠ¨é€‰ä¸­é»˜è®¤é£Ÿå“
    selectedFoods = ['ç‰›å¥¶', 'é¢åŒ…'];
    document.querySelectorAll('.food-chip').forEach(chip => {
        if (chip.textContent === 'ç‰›å¥¶' || chip.textContent === 'é¢åŒ…') {
            chip.classList.add('selected');
        }
    });
    
    updateUI();
    fillFoodTable(); // æ›´æ–°è¡¨æ ¼é«˜äº®
}

// æ»‘åŠ¨æ¡å’Œè¾“å…¥æ¡†è”åŠ¨
function updateBudget(value) {
    const budget = parseFloat(value);
    document.getElementById('budget').value = budget;
    document.getElementById('budgetInput').value = budget;
    
    // æä¾›è§†è§‰åé¦ˆ
    const resultPanels = [
        document.getElementById('result-panel-basic'),
        document.getElementById('result-panel-objective'),
        document.getElementById('result-panel-full')
    ];
    
    for (const panel of resultPanels) {
        if (panel && panel.style.display !== 'none') {
            panel.classList.add('highlight-update');
            setTimeout(() => {
                panel.classList.remove('highlight-update');
            }, 300);
        }
    }
    
    updateUI();
}

function updateCalorie(value) {
    const calorie = parseFloat(value);
    document.getElementById('calorie').value = calorie;
    document.getElementById('calorieInput').value = calorie;
    
    // æä¾›è§†è§‰åé¦ˆ
    const resultPanels = [
        document.getElementById('result-panel-basic'),
        document.getElementById('result-panel-objective'),
        document.getElementById('result-panel-full')
    ];
    
    for (const panel of resultPanels) {
        if (panel && panel.style.display !== 'none') {
            panel.classList.add('highlight-update');
            setTimeout(() => {
                panel.classList.remove('highlight-update');
            }, 300);
        }
    }
    
    updateUI();
}

// ============== å¡«å……é£Ÿå“è¡¨æ ¼ ==============
function fillFoodTable() {
    const tableBody = document.getElementById('foodTableBody');
    if (!tableBody) return;
    
    tableBody.innerHTML = '';
    
    for (const [foodName, foodData] of Object.entries(foodDatabase)) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${foodName}</td>
            <td>${foodData.price}</td>
            <td>${foodData.calorie}</td>
            <td>${foodData.nutrition}</td>
        `;
        
        // å¦‚æœæ˜¯é€‰ä¸­çš„é£Ÿå“ï¼Œæ·»åŠ é«˜äº®
        if (selectedFoods.includes(foodName)) {
            row.classList.add('selected');
        }
        
        // æ·»åŠ ç‚¹å‡»é€‰æ‹©åŠŸèƒ½
        row.addEventListener('click', function() {
            const foodChips = document.querySelectorAll('.food-chip');
            for (const chip of foodChips) {
                if (chip.textContent === foodName) {
                    selectFood(chip, foodName);
                    // æ›´æ–°è¡¨æ ¼è¡Œé«˜äº®
                    if (selectedFoods.includes(foodName)) {
                        row.classList.add('selected');
                    } else {
                        row.classList.remove('selected');
                    }
                    break;
                }
            }
        });
        
        tableBody.appendChild(row);
    }
}

// ============== æ›´æ–°æ•°å­¦æ–¹ç¨‹ ==============
function updateEquations() {
    // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
    if (!document.getElementById('var1Name') || 
        !document.getElementById('var2Name') || 
        !document.getElementById('budgetEq') || 
        !document.getElementById('calorieEq') || 
        !document.getElementById('objectiveEq')) {
        return;
    }
    
    // æ›´æ–°å˜é‡åç§°
    document.getElementById('var1Name').textContent = products.food1.name;
    document.getElementById('var2Name').textContent = products.food2.name;
    
    // æ›´æ–°çº¦æŸæ–¹ç¨‹
    const budget = document.getElementById('budgetInput').value;
    const calorie = document.getElementById('calorieInput').value;
    
    document.getElementById('budgetEq').textContent = 
        `${products.food1.price}x + ${products.food2.price}y â‰¤ ${budget} (é¢„ç®—çº¦æŸ)`;
    document.getElementById('calorieEq').textContent = 
        `${products.food1.calorie}x + ${products.food2.calorie}y â‰¤ ${calorie} (çƒ­é‡çº¦æŸ)`;
    
    // æ›´æ–°ç›®æ ‡å‡½æ•°
    const objective = document.getElementById('objective').value;
    let objectiveText = '';
    switch (objective) {
        case 'maxCalorie':
            objectiveText = `æœ€å¤§åŒ– Z = ${products.food1.calorie}x + ${products.food2.calorie}y (æœ€å¤§åŒ–çƒ­é‡)`;
            break;
        case 'minCost':
            objectiveText = `æœ€å°åŒ– Z = ${products.food1.price}x + ${products.food2.price}y (æœ€å°åŒ–æˆæœ¬)`;
            break;
        case 'maxNutrition':
            objectiveText = `æœ€å¤§åŒ– Z = ${products.food1.nutrition}x + ${products.food2.nutrition}y (æœ€å¤§åŒ–è¥å…»)`;
            break;
    }
    document.getElementById('objectiveEq').textContent = objectiveText;
}

// æ·»åŠ ä»»åŠ¡å¼•å¯¼åŠŸèƒ½
const tasks = [
    {
        id: 'task1',
        title: 'åˆè¯†çº¿æ€§è§„åˆ’',
        modules: ['intro-module', 'food-selection-module', 'food-data-module'], // æ·»åŠ é£Ÿå“æ•°æ®æ¨¡å—åˆ°ç¬¬ä¸€æ­¥
        completed: false
    },
    {
        id: 'task2',
        title: 'è®¾ç½®çº¦æŸæ¡ä»¶',
        // ç¡®ä¿ç¬¬äºŒæ­¥æ˜¾ç¤ºçº¦æŸæ¡ä»¶å’Œæ•°å­¦æ¨¡å‹ï¼Œä»¥åŠç»“æœé¢æ¿(ä½†åªæ˜¾ç¤ºåŸºç¡€ä¿¡æ¯)
        modules: ['constraint-module', 'equation-module', 'result-panel-basic'],
        completed: false
    },
    {
        id: 'task3',
        title: 'è®¾å®šä¼˜åŒ–ç›®æ ‡',
        modules: ['objective-module', 'result-panel-objective'], // æ·»åŠ ç‰¹å®šçš„ç»“æœé¢æ¿
        completed: false
    },
    {
        id: 'task4',
        title: 'å¯è¡ŒåŸŸæ¢ç´¢',
        modules: ['feasible-region-module', 'vertex-module'],
        completed: false
    },
    {
        id: 'task5',
        title: 'å¯»æ‰¾æœ€ä¼˜è§£',
        modules: ['optimal-solution-module', 'result-panel-full', 'controlPanel'],
        completed: false
    }
];

let currentTaskIndex = 0;

function showTask(taskIndex) {
    // éšè—æ‰€æœ‰ä»»åŠ¡å†…å®¹
    document.querySelectorAll('.task-content').forEach(content => {
        content.classList.remove('active');
    });
    
    // ç§»é™¤æ‰€æœ‰ä»»åŠ¡é¡¹çš„activeç±»
    document.querySelectorAll('.task-item').forEach(item => {
        item.classList.remove('active');
    });
    
    // éšè—æ‰€æœ‰ç»“æœé¢æ¿
    document.getElementById('result-panel-basic').style.display = 'none';
    document.getElementById('result-panel-objective').style.display = 'none';
    document.getElementById('result-panel-full').style.display = 'none';
    
    // æ˜¾ç¤ºå½“å‰ä»»åŠ¡å†…å®¹
    const currentTask = tasks[taskIndex];
    const contentElement = document.getElementById(`content-${currentTask.id}`);
    if (contentElement) {
        contentElement.classList.add('active');
    }
    
    document.getElementById(currentTask.id).classList.add('active');
    
    // éšè—æ‰€æœ‰æ¨¡å—
    document.querySelectorAll('.module-container').forEach(module => {
        module.style.display = 'none';
    });
    
    // æ˜¾ç¤ºå½“å‰ä»»åŠ¡ç›¸å…³çš„æ¨¡å—
    currentTask.modules.forEach(moduleId => {
        const moduleElement = document.getElementById(moduleId);
        if (moduleElement) {
            moduleElement.style.display = 'block';
        }
        
        // ç‰¹æ®Šå¤„ç†ç»“æœé¢æ¿ï¼Œå› ä¸ºå®ƒä»¬ä¸æ˜¯module-containerç±»
        if (moduleId === 'result-panel-basic') {
            document.getElementById('result-panel-basic').style.display = 'block';
        } else if (moduleId === 'result-panel-objective') {
            document.getElementById('result-panel-objective').style.display = 'block';
        } else if (moduleId === 'result-panel-full') {
            document.getElementById('result-panel-full').style.display = 'block';
        }
    });
    
    // æ›´æ–°å½“å‰ä»»åŠ¡ç´¢å¼•
    currentTaskIndex = taskIndex;
    
    // å§‹ç»ˆæ˜¾ç¤ºå›¾è¡¨åŒºåŸŸï¼Œå¹¶ç¡®ä¿å…¶åœ¨æœ€é¡¶å±‚
    const chartContainer = document.getElementById('chart-container');
    chartContainer.style.display = 'block';
    chartContainer.style.zIndex = '10';
    
    // æ›´æ–°UIå’Œç»“æœæ˜¾ç¤º
    updateUI();
}

function markTaskCompleted(taskIndex) {
    tasks[taskIndex].completed = true;
    const statusElement = document.querySelector(`#${tasks[taskIndex].id} .task-status`);
    if (statusElement) {
        statusElement.textContent = 'å·²å®Œæˆ';
    }
    document.getElementById(tasks[taskIndex].id).classList.add('completed');
}

function nextTask() {
    if (currentTaskIndex < tasks.length - 1) {
        // æ ‡è®°å½“å‰ä»»åŠ¡ä¸ºå·²å®Œæˆ
        markTaskCompleted(currentTaskIndex);
        // æ˜¾ç¤ºä¸‹ä¸€ä¸ªä»»åŠ¡
        showTask(currentTaskIndex + 1);
    }
}

function prevTask() {
    if (currentTaskIndex > 0) {
        showTask(currentTaskIndex - 1);
    }
}

// åˆå§‹åŒ–ä»»åŠ¡ç•Œé¢
function initTaskUI() {
    // æ˜¾ç¤ºç¬¬ä¸€ä¸ªä»»åŠ¡
    showTask(0);
    
    // æ·»åŠ ä»»åŠ¡åˆ—è¡¨é¡¹çš„ç‚¹å‡»äº‹ä»¶
    document.querySelectorAll('.task-item').forEach((item, index) => {
        item.addEventListener('click', () => {
            showTask(index);
        });
    });
    
    // æ˜¾ç¤ºæ•™å­¦æŒ‡å¯¼æŒ‰é’®
    document.querySelector('.tutorial-btn').style.display = 'block';
}

// åœ¨é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // ç¡®ä¿é¡µé¢å†…å®¹å…¨éƒ¨åŠ è½½å®Œæ¯•
    setTimeout(function() {
        try {
            // æ£€æŸ¥å’Œåˆ›å»ºç¼ºå¤±çš„UIå…ƒç´ 
            if (!document.getElementById('loadingTip')) {
                const loadingTip = document.createElement('div');
                loadingTip.id = 'loadingTip';
                loadingTip.className = 'loading';
                loadingTip.textContent = 'åŠ è½½ä¸­...';
                document.getElementById('chart-container').appendChild(loadingTip);
            }
            
            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°çº¦æŸæ¨¡å—ï¼Œåˆ›å»ºä¸€ä¸ª
            if (!document.getElementById('constraint-module')) {
                const constraintModule = document.createElement('div');
                constraintModule.id = 'constraint-module';
                constraintModule.className = 'module-container';
                constraintModule.innerHTML = `
                    <div class="module-header">
                        <h3>ğŸ”§ çº¦æŸæ¡ä»¶è®¾ç½®</h3>
                    </div>
                    <p>è°ƒæ•´ä»¥ä¸‹æ»‘å—æ¥è®¾ç½®ä¸åŒçš„é¢„ç®—å’Œçƒ­é‡çº¦æŸï¼š</p>
                    <div class="control-item">
                        <label for="budget">é¢„ç®—çº¦æŸ</label>
                        <div class="slider-container">
                            <input type="range" id="budget" min="10" max="100" value="30" oninput="updateBudget(this.value)">
                            <input type="number" id="budgetInput" min="10" max="100" value="30" onchange="updateBudget(this.value)">
                        </div>
                    </div>
                    
                    <div class="control-item">
                        <label for="calorie">çƒ­é‡ä¸Šé™</label>
                        <div class="slider-container">
                            <input type="range" id="calorie" min="300" max="2000" value="800" oninput="updateCalorie(this.value)">
                            <input type="number" id="calorieInput" min="300" max="2000" value="800" onchange="updateCalorie(this.value)">
                        </div>
                    </div>
                    <div class="button-group">
                        <button onclick="prevTask()">è¿”å›ä¸Šä¸€æ­¥</button>
                        <button onclick="nextTask()" style="background:#52c41a;">ç»§ç»­ä¸‹ä¸€æ­¥</button>
                    </div>
                `;
                document.querySelector('.controls-column').appendChild(constraintModule);
            }
        } catch (e) {
            console.error("åˆå§‹åŒ–UIå…ƒç´ é”™è¯¯:", e);
        }
    }, 500);
});

// æ¨¡å—æ³¨å†Œ
const moduleRegistry = {
    'intro-module': {
        init: function() {
            // åˆå§‹åŒ–ä»‹ç»æ¨¡å—
        },
        update: function() {
            // æ›´æ–°ä»‹ç»æ¨¡å—
        }
    },
    'food-selection-module': {
        init: function() {
            // åˆå§‹åŒ–é£Ÿå“é€‰æ‹©æ¨¡å—
            fillFoodTable();
        },
        update: function() {
            // æ›´æ–°é£Ÿå“é€‰æ‹©æ¨¡å—
        }
    },
    // å…¶ä»–æ¨¡å—æ³¨å†Œ...
};

function initModules() {
    // åˆå§‹åŒ–æ‰€æœ‰æ¨¡å—
    Object.values(moduleRegistry).forEach(module => {
        if(module.init) module.init();
    });
}

// åœ¨é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–ä»»åŠ¡å’Œæ¨¡å—
window.addEventListener('load', function() {
    initModules();
    initTaskUI();
});

// ä¿®å¤syncControlValueså‡½æ•°ä¸­çš„é”™è¯¯å¤„ç†
function syncControlValues() {
    try {
        // è·å–ä¸»æ§åˆ¶é¢æ¿çš„å€¼
        const budgetInput = document.getElementById('budgetInput');
        const calorieInput = document.getElementById('calorieInput');
        const objectiveSelect = document.getElementById('objective');
        
        if (!budgetInput || !calorieInput || !objectiveSelect) {
            console.warn("æ— æ³•æ‰¾åˆ°ä¸»æ§åˆ¶é¢æ¿çš„å…ƒç´ ");
            return;
        }
        
        const budgetValue = budgetInput.value;
        const calorieValue = calorieInput.value;
        const objectiveValue = objectiveSelect.value;
        
        // åŒæ­¥åˆ°å…¶ä»–æ§åˆ¶é¢æ¿ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        const budgetControlInput = document.getElementById('budgetInput-control');
        const calorieControlInput = document.getElementById('calorieInput-control');
        const objectiveControlSelect = document.getElementById('objective-control');
        
        if (budgetControlInput) {
            budgetControlInput.value = budgetValue;
        }
        
        if (calorieControlInput) {
            calorieControlInput.value = calorieValue;
        }
        
        if (objectiveControlSelect) {
            objectiveControlSelect.value = objectiveValue;
        }
        
        // åŒæ­¥æ»‘å—å€¼
        const budgetSlider = document.getElementById('budget');
        const calorieSlider = document.getElementById('calorie');
        const budgetControlSlider = document.getElementById('budget-control');
        const calorieControlSlider = document.getElementById('calorie-control');
        
        if (budgetSlider) {
            budgetSlider.value = budgetValue;
        }
        
        if (calorieSlider) {
            calorieSlider.value = calorieValue;
        }
        
        if (budgetControlSlider) {
            budgetControlSlider.value = budgetValue;
        }
        
        if (calorieControlSlider) {
            calorieControlSlider.value = calorieValue;
        }
    } catch (e) {
        console.error("åŒæ­¥æ§åˆ¶é¢æ¿å€¼æ—¶å‡ºé”™:", e);
    }
}

// ============== è®¡ç®—æœ€ä¼˜è§£å¹¶æ˜¾ç¤ºç»“æœ ==============
function updateResults() {
    try {
        // è·å–å‚æ•°
        const budget = parseFloat(document.getElementById('budgetInput').value);
        const calorie = parseFloat(document.getElementById('calorieInput').value);
        const objective = document.getElementById('objective').value;
        
        // è®¡ç®—å¯è¡ŒåŸŸé¡¶ç‚¹
        const vertices = calculateVertices(budget, calorie);
        
        // åŸºç¡€ä¿¡æ¯é¢æ¿ - é€‚ç”¨äºä»»åŠ¡2
        const basicPanel = document.getElementById('result-panel-basic');
        const basicContent = document.getElementById('resultContent-basic');
        
        if (basicPanel && basicContent) {
            if (vertices.length === 0) {
                basicContent.innerHTML = '<p><b>âš ï¸ æç¤º</b>: å½“å‰çº¦æŸæ¡ä»¶ä¸‹æ²¡æœ‰å¯è¡Œè§£</p>';
            } else {
                // åªæ˜¾ç¤ºçº¦æŸæƒ…å†µ
                basicContent.innerHTML = `
                    <p><b>çº¦æŸæ¡ä»¶</b></p>
                    <p>é¢„ç®—é™åˆ¶: ${budget}å…ƒ</p>
                    <p>çƒ­é‡ä¸Šé™: ${calorie}åƒå¡</p>
                    <p>å¯è¡Œç‚¹æ•°é‡: ${vertices.length}ä¸ª</p>
                    <p class="panel-tip">è°ƒæ•´å·¦ä¾§æ»‘å—æŸ¥çœ‹å¯è¡ŒåŸŸå˜åŒ–</p>
                `;
            }
        }
        
        // ä¼˜åŒ–ç›®æ ‡é¢æ¿ - é€‚ç”¨äºä»»åŠ¡3
        const objectivePanel = document.getElementById('result-panel-objective');
        const objectiveContent = document.getElementById('resultContent-objective');
        
        if (objectivePanel && objectiveContent) {
            if (vertices.length === 0) {
                objectiveContent.innerHTML = '<p><b>âš ï¸ æç¤º</b>: å½“å‰çº¦æŸæ¡ä»¶ä¸‹æ²¡æœ‰å¯è¡Œè§£</p>';
            } else {
                // æ˜¾ç¤ºæ‰€é€‰ä¼˜åŒ–ç›®æ ‡ï¼Œä½†ä¸ç›´æ¥æ˜¾ç¤ºæœ€ä¼˜è§£
                let objectiveName = '';
                switch (objective) {
                    case 'maxCalorie': objectiveName = 'æœ€å¤§åŒ–çƒ­é‡æ‘„å…¥'; break;
                    case 'minCost': objectiveName = 'æœ€å°åŒ–æ”¯å‡ºæˆæœ¬'; break;
                    case 'maxNutrition': objectiveName = 'æœ€å¤§åŒ–è¥å…»å¾—åˆ†'; break;
                }
                
                // è®¡ç®—ç›®æ ‡å‡½æ•°çš„ç³»æ•°
                let coefficientX, coefficientY;
                switch (objective) {
                    case 'maxCalorie': 
                        coefficientX = products.food1.calorie;
                        coefficientY = products.food2.calorie;
                        break;
                    case 'minCost': 
                        coefficientX = products.food1.price;
                        coefficientY = products.food2.price;
                        break;
                    case 'maxNutrition': 
                        coefficientX = products.food1.nutrition;
                        coefficientY = products.food2.nutrition;
                        break;
                }
                
                objectiveContent.innerHTML = `
                    <p><b>ä¼˜åŒ–ç›®æ ‡</b>: ${objectiveName}</p>
                    <p>ç›®æ ‡å‡½æ•°: ${objective === 'minCost' ? 'æœ€å°åŒ–' : 'æœ€å¤§åŒ–'} ${coefficientX}x + ${coefficientY}y</p>
                    <p>é¢„ç®—é™åˆ¶: ${budget}å…ƒ</p>
                    <p>çƒ­é‡ä¸Šé™: ${calorie}åƒå¡</p>
                    <p class="panel-tip">ä¸‹ä¸€æ­¥å°†æ¢ç´¢å¯è¡ŒåŸŸçš„é¡¶ç‚¹</p>
                `;
            }
        }
        
        // å®Œæ•´ç»“æœé¢æ¿ - é€‚ç”¨äºä»»åŠ¡5
        const fullPanel = document.getElementById('result-panel-full');
        const fullContent = document.getElementById('resultContent-full');
        
        if (fullPanel && fullContent) {
            if (vertices.length === 0) {
                fullContent.innerHTML = '<p><b>âš ï¸ æç¤º</b>: å½“å‰çº¦æŸæ¡ä»¶ä¸‹æ²¡æœ‰å¯è¡Œè§£</p>';
                return;
            }
            
            // è®¡ç®—æ¯ä¸ªé¡¶ç‚¹çš„ç›®æ ‡å‡½æ•°å€¼
            const vertexValues = vertices.map(v => {
                const cost = v.x * products.food1.price + v.y * products.food2.price;
                const calories = v.x * products.food1.calorie + v.y * products.food2.calorie;
                const nutrition = v.x * products.food1.nutrition + v.y * products.food2.nutrition;
                
                return {
                    vertex: v,
                    cost: cost,
                    calories: calories,
                    nutrition: nutrition
                };
            });
            
            // æ‰¾å‡ºæœ€ä¼˜è§£
            let optimal;
            switch (objective) {
                case 'maxCalorie':
                    optimal = vertexValues.reduce((best, current) => 
                        current.calories > best.calories ? current : best, vertexValues[0]);
                    break;
                case 'minCost':
                    optimal = vertexValues.reduce((best, current) => 
                        current.cost < best.cost ? current : best, vertexValues[0]);
                    break;
                case 'maxNutrition':
                    optimal = vertexValues.reduce((best, current) => 
                        current.nutrition > best.nutrition ? current : best, vertexValues[0]);
                    break;
            }
            
            // ç¡®å®šç›®æ ‡åç§°
            let objectiveName = '';
            switch (objective) {
                case 'maxCalorie': objectiveName = 'æœ€å¤§åŒ–çƒ­é‡æ‘„å…¥'; break;
                case 'minCost': objectiveName = 'æœ€å°åŒ–æ”¯å‡ºæˆæœ¬'; break;
                case 'maxNutrition': objectiveName = 'æœ€å¤§åŒ–è¥å…»å¾—åˆ†'; break;
            }
            
            // æ˜¾ç¤ºå®Œæ•´ç»“æœ
            fullContent.innerHTML = `
                <p><b>ğŸ¯ ${objectiveName}</b></p>
                <p>æœ€ä¼˜æ–¹æ¡ˆï¼š${optimal.vertex.x.toFixed(1)}ä¸ª${products.food1.name} + ${optimal.vertex.y.toFixed(1)}ä¸ª${products.food2.name}</p>
                <p>æ¶ˆè´¹é‡‘é¢ï¼š${optimal.cost.toFixed(2)}å…ƒ</p>
                <p>è·å¾—çƒ­é‡ï¼š${optimal.calories.toFixed(0)}åƒå¡</p>
                <p>è¥å…»å¾—åˆ†ï¼š${optimal.nutrition.toFixed(0)}åˆ†</p>
                <p class="panel-tip">ç‚¹å‡»"å¼€å§‹é¡¶ç‚¹æ£€éªŒ"æŸ¥çœ‹è¿‡ç¨‹</p>
            `;
        }
    } catch (e) {
        console.error("æ›´æ–°ç»“æœé”™è¯¯:", e);
    }
}

// ============== æ§åˆ¶åŠ¨ç”»ç³»ç»Ÿ ==============
function startAnimation() {
    try {
        // åœæ­¢ä»»ä½•ç°æœ‰åŠ¨ç”»
        stopAllAnimations();
        
        // ç¡®ä¿æ˜¾ç¤ºé¡¶ç‚¹
        if (!showVertices) {
            toggleVertex();
        }
        
        // è·å–å‚æ•°
        const budget = parseFloat(document.getElementById('budgetInput').value);
        const calorie = parseFloat(document.getElementById('calorieInput').value);
        
        // è®¡ç®—å¯è¡ŒåŸŸé¡¶ç‚¹
        const vertices = calculateVertices(budget, calorie);
        
        // åˆ›å»ºåŠ¨ç”»æ­¥éª¤
        animationSteps = [];
    const objType = document.getElementById('objective').value;
    
    // é¡¶ç‚¹éå†é˜¶æ®µ
    vertices.forEach(v => {
            if (v.x > 0 || v.y > 0) { // æ’é™¤åŸç‚¹
                const cost = v.x * products.food1.price + v.y * products.food2.price;
                const calories = v.x * products.food1.calorie + v.y * products.food2.calorie;
                const nutrition = v.x * products.food1.nutrition + v.y * products.food2.nutrition;
                
                animationSteps.push({
                    action: 'check',
            vertex: v,
                    cost: cost,
                    calories: calories,
                    nutrition: nutrition
                });
            }
        });
        
        if (animationSteps.length === 0) {
            alert("æ²¡æœ‰å¯è¡Œè§£ï¼Œæ— æ³•æ‰§è¡ŒåŠ¨ç”»");
            return;
        }
        
        // ç¡®å®šæœ€ä¼˜é¡¶ç‚¹
        let bestVertex;
        switch (objType) {
            case 'maxCalorie':
                bestVertex = vertices.reduce((best, current) => {
                    const bestVal = best.x * products.food1.calorie + best.y * products.food2.calorie;
                    const currentVal = current.x * products.food1.calorie + current.y * products.food2.calorie;
                    return currentVal > bestVal ? current : best;
                }, vertices[0]);
                break;
            case 'minCost':
                bestVertex = vertices.reduce((best, current) => {
                    const bestVal = best.x * products.food1.price + best.y * products.food2.price;
                    const currentVal = current.x * products.food1.price + current.y * products.food2.price;
                    return currentVal < bestVal ? current : best;
                }, vertices[0]);
                break;
            case 'maxNutrition':
                bestVertex = vertices.reduce((best, current) => {
                    const bestVal = best.x * products.food1.nutrition + best.y * products.food2.nutrition;
                    const currentVal = current.x * products.food1.nutrition + current.y * products.food2.nutrition;
                    return currentVal > bestVal ? current : best;
                }, vertices[0]);
                break;
        }
        
        const bestCost = bestVertex.x * products.food1.price + bestVertex.y * products.food2.price;
        const bestCalories = bestVertex.x * products.food1.calorie + bestVertex.y * products.food2.calorie;
        const bestNutrition = bestVertex.x * products.food1.nutrition + bestVertex.y * products.food2.nutrition;
        
        // æ·»åŠ æœ€ç»ˆç¡®å®šæ­¥éª¤
        animationSteps.push({
        action: 'final',
            vertex: bestVertex,
            cost: bestCost,
            calories: bestCalories,
            nutrition: bestNutrition
        });
        
        // å¯åŠ¨åŠ¨ç”»
        document.getElementById('animateBtn').disabled = true;
        currentStep = 0;
        animationTimer = setInterval(executeAnimationStep, 1500);
        
        // ç«‹å³æ‰§è¡Œç¬¬ä¸€æ­¥
        executeAnimationStep();
        
    } catch (e) {
        console.error("å¯åŠ¨åŠ¨ç”»é”™è¯¯:", e);
        alert("å¯åŠ¨åŠ¨ç”»æ—¶å‡ºé”™: " + e.message);
    }
}

// ============== æ‰§è¡Œå•ä¸ªåŠ¨ç”»æ­¥éª¤ ==============
function executeAnimationStep() {
    if (currentStep >= animationSteps.length) {
        stopAllAnimations();
        return;
    }
    
    try {
        document.getElementById('loadingTip').style.display = 'block';
        
        // è·å–å½“å‰æ­¥éª¤
        const step = animationSteps[currentStep];
        if (!step || !step.vertex) {
            console.error("å½“å‰æ­¥éª¤æ•°æ®æ— æ•ˆ");
            stopAllAnimations();
            return;
        }
        
        // è·å–å‚æ•°
        const budget = parseFloat(document.getElementById('budgetInput').value);
        const calorie = parseFloat(document.getElementById('calorieInput').value);
        
        // æ˜¾ç¤ºå½“å‰æ­¥éª¤ä¿¡æ¯
        const resultPanel = document.getElementById('result-panel-full');
        const resultContent = document.getElementById('resultContent-full');
        
        if (resultPanel && resultContent) {
            resultPanel.style.display = 'block';
        
            const objective = document.getElementById('objective').value;
            let objectiveDesc, objectiveValue;
            
            switch (objective) {
                case 'maxCalorie': 
                    objectiveDesc = 'çƒ­é‡'; 
                    objectiveValue = step.calories.toFixed(0) + "åƒå¡";
                    break;
                case 'minCost': 
                    objectiveDesc = 'æˆæœ¬'; 
                    objectiveValue = step.cost.toFixed(2) + "å…ƒ";
                    break;
                case 'maxNutrition': 
                    objectiveDesc = 'è¥å…»å¾—åˆ†'; 
                    objectiveValue = step.nutrition.toFixed(0) + "åˆ†";
                    break;
            }
            
            // æ˜¾ç¤ºå½“å‰æ£€éªŒç‚¹çš„ä¿¡æ¯
            if (step.action === 'final') {
                resultContent.innerHTML = `
                    <p><b>ğŸ¯ æ‰¾åˆ°æœ€ä¼˜è§£ï¼</b></p>
                    <p>æœ€ä¼˜æ–¹æ¡ˆï¼š${step.vertex.x.toFixed(1)}ä¸ª${products.food1.name} + ${step.vertex.y.toFixed(1)}ä¸ª${products.food2.name}</p>
                    <p>æ¶ˆè´¹é‡‘é¢ï¼š${step.cost.toFixed(2)}å…ƒ</p>
                    <p>è·å¾—çƒ­é‡ï¼š${step.calories.toFixed(0)}åƒå¡</p>
                    <p>è¥å…»å¾—åˆ†ï¼š${step.nutrition.toFixed(0)}åˆ†</p>
                    <p>ç›®æ ‡${objectiveDesc}ï¼š${objectiveValue}</p>
                `;
            } else {
                resultContent.innerHTML = `
                    <p><b>ğŸ” æ£€éªŒé¡¶ç‚¹</b>: (${step.vertex.x.toFixed(1)}, ${step.vertex.y.toFixed(1)})</p>
                    <p>æ¶ˆè´¹é‡‘é¢ï¼š${step.cost.toFixed(2)}å…ƒ</p>
                    <p>è·å¾—çƒ­é‡ï¼š${step.calories.toFixed(0)}åƒå¡</p>
                    <p>è¥å…»å¾—åˆ†ï¼š${step.nutrition.toFixed(0)}åˆ†</p>
                    <p>ç›®æ ‡${objectiveDesc}ï¼š${objectiveValue}</p>
                `;
            }
        }
        
        // é‡æ–°æ¸²æŸ“å›¾è¡¨æ¥æ˜¾ç¤ºåŠ¨ç”»ç‚¹
        renderChart();
        
        // å¢åŠ æ­¥éª¤è®¡æ•°
        currentStep++;
        
    } catch (e) {
        console.error("æ‰§è¡ŒåŠ¨ç”»æ­¥éª¤é”™è¯¯:", e);
        stopAllAnimations();
    } finally {
        document.getElementById('loadingTip').style.display = 'none';
    }
}

// ============== æ˜¾ç¤º/éšè—ç›®æ ‡å‡½æ•°çº¿ ==============
function toggleObjectiveLine() {
    showObjectiveLine = !showObjectiveLine;
    
    const objectiveLineBtn = document.getElementById('objectiveLineBtn');
    if (objectiveLineBtn) {
        objectiveLineBtn.textContent = showObjectiveLine ? 'éšè—ç›®æ ‡å‡½æ•°çº¿' : 'æ˜¾ç¤ºç›®æ ‡å‡½æ•°çº¿';
    }
    
    // æ›´æ–°å›¾è¡¨
    renderChart();
}
</script>
</body>
</html>

